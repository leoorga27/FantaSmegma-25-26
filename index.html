<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FantaSmegma League 25/26</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Outfit', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glow-green { box-shadow: 0 0 30px rgba(16, 185, 129, 0.3); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-row { animation: fadeIn 0.3s ease-out forwards; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-950 text-white min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icons = {
            Trophy: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            BarChart: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>,
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Target: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Shield: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>,
            Zap: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            TrendingUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
            Activity: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        };

        const defaultGoalsCSV = `Date,HomeTeam,AwayTeam,HGoals,AGoals,Result
1,Sbrocca Junior,Stiratoallagoccia,4,0,H
1,CISK FC,FC Ludopatykos,0,1,A
1,GIOIA E RIVOLUZIONE,HISTORIAS Y SABORES,0,2,A
1,FC Salisburo,Sbuchester United,3,4,A
2,Stiratoallagoccia,FC Salisburo,0,2,A
2,Sbuchester United,GIOIA E RIVOLUZIONE,0,2,A
2,HISTORIAS Y SABORES,CISK FC,6,2,H
2,FC Ludopatykos,Sbrocca Junior,2,2,D
3,CISK FC,Sbuchester United,4,3,H
3,GIOIA E RIVOLUZIONE,Stiratoallagoccia,2,1,H
3,FC Salisburo,Sbrocca Junior,4,0,H
3,HISTORIAS Y SABORES,FC Ludopatykos,4,2,H
4,Sbrocca Junior,GIOIA E RIVOLUZIONE,4,4,D
4,Stiratoallagoccia,CISK FC,0,0,D
4,Sbuchester United,HISTORIAS Y SABORES,2,4,A
4,FC Ludopatykos,FC Salisburo,3,0,H
5,CISK FC,Sbrocca Junior,2,0,H
5,GIOIA E RIVOLUZIONE,FC Salisburo,0,2,A
5,Sbuchester United,FC Ludopatykos,1,1,D
5,HISTORIAS Y SABORES,Stiratoallagoccia,1,1,D
6,Sbrocca Junior,HISTORIAS Y SABORES,2,0,H
6,Stiratoallagoccia,Sbuchester United,0,1,A
6,GIOIA E RIVOLUZIONE,FC Ludopatykos,2,0,H
6,FC Salisburo,CISK FC,3,3,D
7,CISK FC,GIOIA E RIVOLUZIONE,1,2,A
7,Sbuchester United,Sbrocca Junior,2,5,A
7,HISTORIAS Y SABORES,FC Salisburo,3,0,H
7,FC Ludopatykos,Stiratoallagoccia,5,4,H
8,Sbrocca Junior,FC Salisburo,1,6,A
8,Stiratoallagoccia,FC Ludopatykos,1,0,H
8,CISK FC,HISTORIAS Y SABORES,1,1,D
8,GIOIA E RIVOLUZIONE,Sbuchester United,3,2,H
9,Sbuchester United,Stiratoallagoccia,2,1,H
9,FC Salisburo,GIOIA E RIVOLUZIONE,2,1,H
9,HISTORIAS Y SABORES,Sbrocca Junior,0,0,D
9,FC Ludopatykos,CISK FC,0,1,A
10,CISK FC,FC Salisburo,5,1,H
10,Sbrocca Junior,Sbuchester United,1,3,A
10,Stiratoallagoccia,GIOIA E RIVOLUZIONE,1,3,A
10,FC Ludopatykos,HISTORIAS Y SABORES,1,8,A
11,Stiratoallagoccia,HISTORIAS Y SABORES,2,1,H
11,GIOIA E RIVOLUZIONE,Sbrocca Junior,4,6,A
11,Sbuchester United,CISK FC,1,2,A
11,FC Salisburo,FC Ludopatykos,2,3,A
12,Sbrocca Junior,CISK FC,2,0,H
12,FC Salisburo,Stiratoallagoccia,1,1,D
12,HISTORIAS Y SABORES,Sbuchester United,1,4,A
12,FC Ludopatykos,GIOIA E RIVOLUZIONE,4,2,H
13,CISK FC,Stiratoallagoccia,2,3,A
13,Sbrocca Junior,FC Ludopatykos,0,2,A
13,Sbuchester United,FC Salisburo,2,1,H
13,HISTORIAS Y SABORES,GIOIA E RIVOLUZIONE,2,2,D`;

        const defaultPointsCSV = `Date,HomeTeam,AwayTeam,HGoals,AGoals,Result
1,Sbrocca Junior,Stiratoallagoccia,80.5,65.0,H
1,CISK FC,FC Ludopatykos,65.5,68.0,A
1,GIOIA E RIVOLUZIONE,HISTORIAS Y SABORES,64.0,72.0,A
1,FC Salisburo,Sbuchester United,74.0,80.0,A
2,Stiratoallagoccia,FC Salisburo,61.0,73.0,A
2,Sbuchester United,GIOIA E RIVOLUZIONE,65.0,70.5,A
2,HISTORIAS Y SABORES,CISK FC,87.0,70.5,H
2,FC Ludopatykos,Sbrocca Junior,73.0,70.0,D
3,CISK FC,Sbuchester United,79.0,75.0,H
3,GIOIA E RIVOLUZIONE,Stiratoallagoccia,71.0,69.5,H
3,FC Salisburo,Sbrocca Junior,78.5,64.5,H
3,HISTORIAS Y SABORES,FC Ludopatykos,78.0,73.0,H
4,Sbrocca Junior,GIOIA E RIVOLUZIONE,79.0,78.5,D
4,Stiratoallagoccia,CISK FC,64.5,62.0,D
4,Sbuchester United,HISTORIAS Y SABORES,72.5,78.5,A
4,FC Ludopatykos,FC Salisburo,74.5,63.5,H
5,CISK FC,Sbrocca Junior,72.5,65.5,H
5,GIOIA E RIVOLUZIONE,FC Salisburo,63.0,71.5,A
5,Sbuchester United,FC Ludopatykos,69.5,69.0,D
5,HISTORIAS Y SABORES,Stiratoallagoccia,67.0,68.0,D
6,Sbrocca Junior,HISTORIAS Y SABORES,70.5,63.0,H
6,Stiratoallagoccia,Sbuchester United,60.5,69.5,A
6,GIOIA E RIVOLUZIONE,FC Ludopatykos,72.5,61.5,H
6,FC Salisburo,CISK FC,75.0,76.0,D
7,CISK FC,GIOIA E RIVOLUZIONE,66.0,72.0,A
7,Sbuchester United,Sbrocca Junior,72.5,84.0,A
7,HISTORIAS Y SABORES,FC Salisburo,74.0,61.5,H
7,FC Ludopatykos,Stiratoallagoccia,82.5,78.0,H
8,Sbrocca Junior,FC Salisburo,64.5,84.0,A
8,Stiratoallagoccia,FC Ludopatykos,68.0,61.5,H
8,CISK FC,HISTORIAS Y SABORES,66.0,66.0,D
8,GIOIA E RIVOLUZIONE,Sbuchester United,76.0,73.0,H
9,Sbuchester United,Stiratoallagoccia,70.0,68.0,H
9,FC Salisburo,GIOIA E RIVOLUZIONE,70.0,67.5,H
9,HISTORIAS Y SABORES,Sbrocca Junior,65.5,65.0,D
9,FC Ludopatykos,CISK FC,61.5,69.0,A
10,CISK FC,FC Salisburo,83.0,67.5,H
10,Sbrocca Junior,Sbuchester United,69.0,75.0,A
10,Stiratoallagoccia,GIOIA E RIVOLUZIONE,68.0,74.5,A
10,FC Ludopatykos,HISTORIAS Y SABORES,68.5,96.0,A
11,Stiratoallagoccia,HISTORIAS Y SABORES,73.0,66.5,H
11,GIOIA E RIVOLUZIONE,Sbrocca Junior,79.5,86.0,A
11,Sbuchester United,CISK FC,69.0,71.5,A
11,FC Salisburo,FC Ludopatykos,70.5,75.5,A
12,Sbrocca Junior,CISK FC,72.0,61.0,H
12,FC Salisburo,Stiratoallagoccia,66.0,69.5,D
12,HISTORIAS Y SABORES,Sbuchester United,68.0,79.5,A
12,FC Ludopatykos,GIOIA E RIVOLUZIONE,78.5,73.0,H
13,CISK FC,Stiratoallagoccia,71.0,75.0,A
13,Sbrocca Junior,FC Ludopatykos,65.5,70.0,A
13,Sbuchester United,FC Salisburo,70.0,66.0,H
13,HISTORIAS Y SABORES,GIOIA E RIVOLUZIONE,71.5,72.5,D`;


        const calculateElo = (matches, kFactor = 32) => {
            const elo = {};
            const teams = [...new Set(matches.flatMap(m => [m.HomeTeam, m.AwayTeam]))];
            teams.forEach(team => elo[team] = 1500);
            const playedMatches = matches.filter(m => m.HGoals !== '' && m.AGoals !== '');
            playedMatches.forEach(match => {
                const homeElo = elo[match.HomeTeam];
                const awayElo = elo[match.AwayTeam];
                const expectedHome = 1 / (1 + Math.pow(10, (awayElo - homeElo) / 400));
                const expectedAway = 1 - expectedHome;
                let actualHome, actualAway;
                if (match.Result === 'H') { actualHome = 1; actualAway = 0; }
                else if (match.Result === 'A') { actualHome = 0; actualAway = 1; }
                else { actualHome = 0.5; actualAway = 0.5; }
                const goalDiff = Math.abs(parseFloat(match.HGoals) - parseFloat(match.AGoals));
                const multiplier = goalDiff === 0 ? 1 : 1 + Math.min(goalDiff * 0.1, 0.5);
                elo[match.HomeTeam] += kFactor * multiplier * (actualHome - expectedHome);
                elo[match.AwayTeam] += kFactor * multiplier * (actualAway - expectedAway);
            });
            return elo;
        };

        const FormBadge = ({ result }) => {
            const colors = { W: 'bg-emerald-500', D: 'bg-amber-500', L: 'bg-red-500' };
            return <span className={`${colors[result]} w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white shadow-lg`}>{result}</span>;
        };

        function App() {
            const [activeTab, setActiveTab] = useState('standings');
            const [matches, setMatches] = useState([]);
            const [pointsMatches, setPointsMatches] = useState([]);
            const [uploadStatus, setUploadStatus] = useState('');
            const [pointsUploadStatus, setPointsUploadStatus] = useState('');
            const [selectedGiornata, setSelectedGiornata] = useState(null);
            const [pointsSort, setPointsSort] = useState({ column: 'avgFor', direction: 'desc' });
            const [teamStatsSort, setTeamStatsSort] = useState({ column: 'attackRating', direction: 'desc' });
            const [homeAwaySort, setHomeAwaySort] = useState({ column: 'homeWinRate', direction: 'desc' });
            const [ratingsSort, setRatingsSort] = useState({ column: 'elo', direction: 'desc' });
            const [simHomeTeam, setSimHomeTeam] = useState('');
            const [simAwayTeam, setSimAwayTeam] = useState('');
            const [coachCompare1, setCoachCompare1] = useState('');
            const [coachCompare2, setCoachCompare2] = useState('');
            const [chiResult, setChiResult] = useState(null);

            const handlePointsSort = (column) => {
                setPointsSort(prev => ({
                    column,
                    direction: prev.column === column && prev.direction === 'desc' ? 'asc' : 'desc'
                }));
            };

            const handleTeamStatsSort = (column) => {
                setTeamStatsSort(prev => ({
                    column,
                    direction: prev.column === column && prev.direction === 'desc' ? 'asc' : 'desc'
                }));
            };

            const handleHomeAwaySort = (column) => {
                setHomeAwaySort(prev => ({
                    column,
                    direction: prev.column === column && prev.direction === 'desc' ? 'asc' : 'desc'
                }));
            };

            const handleRatingsSort = (column) => {
                setRatingsSort(prev => ({
                    column,
                    direction: prev.column === column && prev.direction === 'desc' ? 'asc' : 'desc'
                }));
            };

            // All Ratings Calculations
            const allRatings = useMemo(() => {
                const playedMatches = matches.filter(m => m.HGoals !== '' && m.AGoals !== '');
                const teams = [...new Set(matches.flatMap(m => [m.HomeTeam, m.AwayTeam]))];
                const n = teams.length;
                if (n === 0 || playedMatches.length === 0) return [];

                const teamIndex = {};
                teams.forEach((t, i) => teamIndex[t] = i);

                // 1. ELO Ratings (k=21)
                const eloRatings = {};
                teams.forEach(t => eloRatings[t] = 1500);
                playedMatches.forEach(match => {
                    const hElo = eloRatings[match.HomeTeam];
                    const aElo = eloRatings[match.AwayTeam];
                    const expH = 1 / (1 + Math.pow(10, (aElo - hElo) / 400));
                    const expA = 1 - expH;
                    let actH, actA;
                    if (match.Result === 'H') { actH = 1; actA = 0; }
                    else if (match.Result === 'A') { actH = 0; actA = 1; }
                    else { actH = 0.5; actA = 0.5; }
                    const gd = Math.abs(parseInt(match.HGoals) - parseInt(match.AGoals));
                    const mult = 1 + Math.min(gd * 0.1, 0.5);
                    eloRatings[match.HomeTeam] += 21 * mult * (actH - expH);
                    eloRatings[match.AwayTeam] += 21 * mult * (actA - expA);
                });

                // 2. Pi Ratings
                const piHome = {}, piAway = {};
                teams.forEach(t => { piHome[t] = 1; piAway[t] = 1; });
                const piLambda = 0.1;
                playedMatches.forEach(match => {
                    const hAttack = piHome[match.HomeTeam];
                    const aDefense = piAway[match.AwayTeam];
                    const aAttack = piAway[match.AwayTeam];
                    const hDefense = piHome[match.HomeTeam];
                    const hGoals = parseInt(match.HGoals);
                    const aGoals = parseInt(match.AGoals);
                    const expH = hAttack * aDefense;
                    const expA = aAttack * hDefense;
                    piHome[match.HomeTeam] += piLambda * (hGoals - expH);
                    piAway[match.AwayTeam] += piLambda * (aGoals - expA);
                });
                const piRatings = {};
                teams.forEach(t => piRatings[t] = (piHome[t] + piAway[t]) / 2);

                // 3. Massey Ratings (least squares)
                const masseyM = Array(n).fill(null).map(() => Array(n).fill(0));
                const masseyB = Array(n).fill(0);
                playedMatches.forEach(match => {
                    const i = teamIndex[match.HomeTeam];
                    const j = teamIndex[match.AwayTeam];
                    const diff = parseInt(match.HGoals) - parseInt(match.AGoals);
                    masseyM[i][i]++; masseyM[j][j]++;
                    masseyM[i][j]--; masseyM[j][i]--;
                    masseyB[i] += diff; masseyB[j] -= diff;
                });
                masseyM[n-1] = Array(n).fill(1);
                masseyB[n-1] = 0;
                const masseyRatings = solveLinear(masseyM, masseyB, teams);

                // 4. Colley Ratings
                const colleyC = Array(n).fill(null).map(() => Array(n).fill(0));
                const colleyB = Array(n).fill(1);
                const wins = {}, losses = {}, gamesPlayed = {};
                teams.forEach(t => { wins[t] = 0; losses[t] = 0; gamesPlayed[t] = 0; });
                playedMatches.forEach(match => {
                    gamesPlayed[match.HomeTeam]++; gamesPlayed[match.AwayTeam]++;
                    const i = teamIndex[match.HomeTeam];
                    const j = teamIndex[match.AwayTeam];
                    colleyC[i][j]--; colleyC[j][i]--;
                    if (match.Result === 'H') { wins[match.HomeTeam]++; losses[match.AwayTeam]++; }
                    else if (match.Result === 'A') { wins[match.AwayTeam]++; losses[match.HomeTeam]++; }
                    else { wins[match.HomeTeam] += 0.5; wins[match.AwayTeam] += 0.5; losses[match.HomeTeam] += 0.5; losses[match.AwayTeam] += 0.5; }
                });
                teams.forEach((t, i) => {
                    colleyC[i][i] = 2 + gamesPlayed[t];
                    colleyB[i] = 1 + (wins[t] - losses[t]) / 2;
                });
                const colleyRatings = solveLinear(colleyC, colleyB, teams);

                // 5. Indice Potenza Calcio (SPI-like)
                const spiOff = {}, spiDef = {};
                teams.forEach(t => { spiOff[t] = 1; spiDef[t] = 1; });
                for (let iter = 0; iter < 20; iter++) {
                    const newOff = {}, newDef = {};
                    teams.forEach(t => { newOff[t] = 0; newDef[t] = 0; });
                    const counts = {};
                    teams.forEach(t => counts[t] = 0);
                    playedMatches.forEach(match => {
                        const h = match.HomeTeam, a = match.AwayTeam;
                        const hg = parseInt(match.HGoals), ag = parseInt(match.AGoals);
                        newOff[h] += hg / spiDef[a]; newDef[h] += ag / spiOff[a];
                        newOff[a] += ag / spiDef[h]; newDef[a] += hg / spiOff[h];
                        counts[h]++; counts[a]++;
                    });
                    teams.forEach(t => {
                        if (counts[t] > 0) {
                            spiOff[t] = newOff[t] / counts[t];
                            spiDef[t] = newDef[t] / counts[t];
                        }
                    });
                }
                const spiRatings = {};
                teams.forEach(t => spiRatings[t] = spiOff[t] / (spiDef[t] || 0.1));

                // 6. Forza Calendario
                const teamPoints = {};
                teams.forEach(t => teamPoints[t] = 0);
                playedMatches.forEach(match => {
                    if (match.Result === 'H') { teamPoints[match.HomeTeam] += 3; }
                    else if (match.Result === 'A') { teamPoints[match.AwayTeam] += 3; }
                    else { teamPoints[match.HomeTeam] += 1; teamPoints[match.AwayTeam] += 1; }
                });
                const opponents = {};
                teams.forEach(t => opponents[t] = []);
                playedMatches.forEach(match => {
                    opponents[match.HomeTeam].push(match.AwayTeam);
                    opponents[match.AwayTeam].push(match.HomeTeam);
                });
                const sosRatings = {};
                teams.forEach(t => {
                    if (opponents[t].length > 0) {
                        const oppAvg = opponents[t].reduce((s, o) => s + (teamPoints[o] / (gamesPlayed[o] || 1)), 0) / opponents[t].length;
                        sosRatings[t] = oppAvg;
                    } else {
                        sosRatings[t] = 0;
                    }
                });

                // 7. Keener Ratings
                const keenerA = Array(n).fill(null).map(() => Array(n).fill(0));
                playedMatches.forEach(match => {
                    const i = teamIndex[match.HomeTeam];
                    const j = teamIndex[match.AwayTeam];
                    const hg = parseInt(match.HGoals), ag = parseInt(match.AGoals);
                    const total = hg + ag + 1;
                    keenerA[i][j] += (hg + 1) / total;
                    keenerA[j][i] += (ag + 1) / total;
                });
                let keenerR = Array(n).fill(1/n);
                for (let iter = 0; iter < 50; iter++) {
                    const newR = Array(n).fill(0);
                    for (let i = 0; i < n; i++) {
                        for (let j = 0; j < n; j++) {
                            newR[i] += keenerA[i][j] * keenerR[j];
                        }
                    }
                    const sum = newR.reduce((a, b) => a + b, 0);
                    keenerR = newR.map(x => x / (sum || 1));
                }
                const keenerRatings = {};
                teams.forEach((t, i) => keenerRatings[t] = keenerR[i] * 100);

                // 8. Bradley-Terry Model
                const btRatings = {};
                teams.forEach(t => btRatings[t] = 1);
                for (let iter = 0; iter < 50; iter++) {
                    const newBT = {};
                    teams.forEach(t => {
                        let num = 0, den = 0;
                        playedMatches.forEach(match => {
                            if (match.HomeTeam === t) {
                                if (match.Result === 'H') num += 1;
                                else if (match.Result === 'D') num += 0.5;
                                den += 1 / (btRatings[t] + btRatings[match.AwayTeam]);
                            } else if (match.AwayTeam === t) {
                                if (match.Result === 'A') num += 1;
                                else if (match.Result === 'D') num += 0.5;
                                den += 1 / (btRatings[match.HomeTeam] + btRatings[t]);
                            }
                        });
                        newBT[t] = den > 0 ? num / den : 1;
                    });
                    const avg = teams.reduce((s, t) => s + newBT[t], 0) / n;
                    teams.forEach(t => btRatings[t] = newBT[t] / avg);
                }

                // Combine all ratings
                return teams.map(team => ({
                    team,
                    elo: Math.round(eloRatings[team]),
                    pi: piRatings[team].toFixed(2),
                    massey: (masseyRatings[team] || 0).toFixed(2),
                    colley: (colleyRatings[team] || 0.5).toFixed(3),
                    spi: (spiRatings[team] || 1).toFixed(2),
                    sos: (sosRatings[team] || 0).toFixed(2),
                    keener: (keenerRatings[team] || 0).toFixed(2),
                    bt: (btRatings[team] || 1).toFixed(2)
                }));
            }, [matches]);

            // Helper: Solve linear system Ax = b using Gaussian elimination
            function solveLinear(A, b, teams) {
                const n = A.length;
                const aug = A.map((row, i) => [...row, b[i]]);
                for (let col = 0; col < n; col++) {
                    let maxRow = col;
                    for (let row = col + 1; row < n; row++) {
                        if (Math.abs(aug[row][col]) > Math.abs(aug[maxRow][col])) maxRow = row;
                    }
                    [aug[col], aug[maxRow]] = [aug[maxRow], aug[col]];
                    if (Math.abs(aug[col][col]) < 1e-10) continue;
                    for (let row = col + 1; row < n; row++) {
                        const f = aug[row][col] / aug[col][col];
                        for (let j = col; j <= n; j++) aug[row][j] -= f * aug[col][j];
                    }
                }
                const x = Array(n).fill(0);
                for (let i = n - 1; i >= 0; i--) {
                    if (Math.abs(aug[i][i]) < 1e-10) { x[i] = 0; continue; }
                    x[i] = aug[i][n];
                    for (let j = i + 1; j < n; j++) x[i] -= aug[i][j] * x[j];
                    x[i] /= aug[i][i];
                }
                const result = {};
                teams.forEach((t, i) => result[t] = x[i]);
                return result;
            }

            const SortIcon = ({ column, current }) => {
                if (current.column !== column) return <span className="ml-1 text-slate-600">â†•</span>;
                return <span className="ml-1">{current.direction === 'desc' ? 'â†“' : 'â†‘'}</span>;
            };

            useEffect(() => {
                const parsedGoals = Papa.parse(defaultGoalsCSV, { header: true, skipEmptyLines: true });
                setMatches(parsedGoals.data);
                const parsedPoints = Papa.parse(defaultPointsCSV, { header: true, skipEmptyLines: true });
                setPointsMatches(parsedPoints.data);
            }, []);

            const handleGoalsUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    Papa.parse(file, {
                        header: true, skipEmptyLines: true,
                        complete: (results) => {
                            // Normalize column names
                            const normalized = results.data.map(row => ({
                                Date: row.Date,
                                HomeTeam: row.HomeTeam,
                                AwayTeam: row.AwayTeam,
                                HGoals: row.HGoals || row.Hpoints || '',
                                AGoals: row.AGoals || row.Apoints || '',
                                Result: row.Result
                            }));
                            setMatches(normalized);
                            setUploadStatus('âœ“ Gol caricati');
                            setTimeout(() => setUploadStatus(''), 3000);
                        },
                        error: (error) => { setUploadStatus('âœ— Errore'); }
                    });
                }
            };

            const handlePointsUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    Papa.parse(file, {
                        header: true, skipEmptyLines: true,
                        complete: (results) => {
                            // Normalize column names (handle Hpoints/Apoints vs HGoals/AGoals)
                            const normalized = results.data.map(row => ({
                                Date: row.Date,
                                HomeTeam: row.HomeTeam,
                                AwayTeam: row.AwayTeam,
                                HGoals: row.HGoals || row.Hpoints || '',
                                AGoals: row.AGoals || row.Apoints || '',
                                Result: row.Result
                            }));
                            setPointsMatches(normalized);
                            setPointsUploadStatus('âœ“ Punti caricati');
                            setTimeout(() => setPointsUploadStatus(''), 3000);
                        },
                        error: (error) => { setPointsUploadStatus('âœ— Errore'); }
                    });
                }
            };

            const standings = useMemo(() => {
                const stats = {};
                const playedMatches = matches.filter(m => m.HGoals !== '' && m.AGoals !== '');
                playedMatches.forEach(match => {
                    [match.HomeTeam, match.AwayTeam].forEach(team => {
                        if (!stats[team]) stats[team] = { team, played: 0, wins: 0, draws: 0, losses: 0, goalsFor: 0, goalsAgainst: 0, points: 0, form: [], homeWins: 0, awayWins: 0 };
                    });
                    const hGoals = parseInt(match.HGoals), aGoals = parseInt(match.AGoals);
                    stats[match.HomeTeam].played++; stats[match.HomeTeam].goalsFor += hGoals; stats[match.HomeTeam].goalsAgainst += aGoals;
                    stats[match.AwayTeam].played++; stats[match.AwayTeam].goalsFor += aGoals; stats[match.AwayTeam].goalsAgainst += hGoals;
                    if (match.Result === 'H') { stats[match.HomeTeam].wins++; stats[match.HomeTeam].homeWins++; stats[match.HomeTeam].points += 3; stats[match.HomeTeam].form.push('W'); stats[match.AwayTeam].losses++; stats[match.AwayTeam].form.push('L'); }
                    else if (match.Result === 'A') { stats[match.AwayTeam].wins++; stats[match.AwayTeam].awayWins++; stats[match.AwayTeam].points += 3; stats[match.AwayTeam].form.push('W'); stats[match.HomeTeam].losses++; stats[match.HomeTeam].form.push('L'); }
                    else { stats[match.HomeTeam].draws++; stats[match.HomeTeam].points += 1; stats[match.HomeTeam].form.push('D'); stats[match.AwayTeam].draws++; stats[match.AwayTeam].points += 1; stats[match.AwayTeam].form.push('D'); }
                });
                return Object.values(stats).sort((a, b) => b.points !== a.points ? b.points - a.points : (b.goalsFor - b.goalsAgainst) - (a.goalsFor - a.goalsAgainst));
            }, [matches]);

            const pointsStats = useMemo(() => {
                const stats = {};
                const playedMatches = pointsMatches.filter(m => m.HGoals !== '' && m.AGoals !== '');
                playedMatches.forEach(match => {
                    [match.HomeTeam, match.AwayTeam].forEach(team => {
                        if (!stats[team]) stats[team] = { team, played: 0, totalFor: 0, totalAgainst: 0, highestScore: 0, lowestScore: Infinity, scores: [] };
                    });
                    const hPoints = parseFloat(match.HGoals), aPoints = parseFloat(match.AGoals);
                    stats[match.HomeTeam].played++; stats[match.HomeTeam].totalFor += hPoints; stats[match.HomeTeam].totalAgainst += aPoints;
                    stats[match.HomeTeam].highestScore = Math.max(stats[match.HomeTeam].highestScore, hPoints);
                    stats[match.HomeTeam].lowestScore = Math.min(stats[match.HomeTeam].lowestScore, hPoints);
                    stats[match.HomeTeam].scores.push(hPoints);
                    stats[match.AwayTeam].played++; stats[match.AwayTeam].totalFor += aPoints; stats[match.AwayTeam].totalAgainst += hPoints;
                    stats[match.AwayTeam].highestScore = Math.max(stats[match.AwayTeam].highestScore, aPoints);
                    stats[match.AwayTeam].lowestScore = Math.min(stats[match.AwayTeam].lowestScore, aPoints);
                    stats[match.AwayTeam].scores.push(aPoints);
                });
                return Object.values(stats).map(team => ({
                    ...team,
                    avgFor: team.played > 0 ? (team.totalFor / team.played).toFixed(1) : 0,
                    avgAgainst: team.played > 0 ? (team.totalAgainst / team.played).toFixed(1) : 0,
                    pointsDiff: (team.totalFor - team.totalAgainst).toFixed(1),
                    consistency: team.scores.length > 1 ? Math.sqrt(team.scores.reduce((sum, s) => sum + Math.pow(s - (team.totalFor / team.played), 2), 0) / team.scores.length).toFixed(1) : 0
                })).sort((a, b) => parseFloat(b.avgFor) - parseFloat(a.avgFor));
            }, [pointsMatches]);

            const eloRatings = useMemo(() => calculateElo(matches), [matches]);

            const teamStats = useMemo(() => {
                const baseStats = standings.map(team => ({
                    ...team,
                    avgFor: team.played > 0 ? (team.goalsFor / team.played) : 0,
                    avgAgainst: team.played > 0 ? (team.goalsAgainst / team.played) : 0,
                    goalDiff: team.goalsFor - team.goalsAgainst,
                    winRate: team.played > 0 ? ((team.wins / team.played) * 100).toFixed(1) : 0
                }));
                
                // Calculate league averages
                const totalTeams = baseStats.length;
                const leagueAvgFor = totalTeams > 0 ? baseStats.reduce((sum, t) => sum + t.avgFor, 0) / totalTeams : 1;
                const leagueAvgAgainst = totalTeams > 0 ? baseStats.reduce((sum, t) => sum + t.avgAgainst, 0) / totalTeams : 1;
                
                // Calculate Attack and Defense ratings
                return baseStats.map(team => ({
                    ...team,
                    avgFor: team.avgFor.toFixed(2),
                    avgAgainst: team.avgAgainst.toFixed(2),
                    attackRating: leagueAvgFor > 0 ? (team.avgFor / leagueAvgFor).toFixed(2) : '1.00',
                    defenseRating: team.avgAgainst > 0 ? (leagueAvgAgainst / team.avgAgainst).toFixed(2) : '1.00'
                })).sort((a, b) => parseFloat(b.attackRating) - parseFloat(a.attackRating));
            }, [standings]);

            const matchdays = useMemo(() => [...new Set(matches.map(m => parseInt(m.Date)))].sort((a, b) => a - b), [matches]);

            const homeAwayStats = useMemo(() => {
                const stats = {};
                const playedMatches = matches.filter(m => m.HGoals !== '' && m.AGoals !== '');
                
                playedMatches.forEach(match => {
                    const homeTeam = match.HomeTeam;
                    const awayTeam = match.AwayTeam;
                    const hGoals = parseInt(match.HGoals);
                    const aGoals = parseInt(match.AGoals);
                    
                    // Initialize teams
                    [homeTeam, awayTeam].forEach(team => {
                        if (!stats[team]) {
                            stats[team] = {
                                team,
                                homeGames: 0, homeWins: 0, homeDraws: 0, homeLosses: 0, homeGF: 0, homeGA: 0,
                                awayGames: 0, awayWins: 0, awayDraws: 0, awayLosses: 0, awayGF: 0, awayGA: 0
                            };
                        }
                    });
                    
                    // Home team stats
                    stats[homeTeam].homeGames++;
                    stats[homeTeam].homeGF += hGoals;
                    stats[homeTeam].homeGA += aGoals;
                    if (match.Result === 'H') stats[homeTeam].homeWins++;
                    else if (match.Result === 'D') stats[homeTeam].homeDraws++;
                    else stats[homeTeam].homeLosses++;
                    
                    // Away team stats
                    stats[awayTeam].awayGames++;
                    stats[awayTeam].awayGF += aGoals;
                    stats[awayTeam].awayGA += hGoals;
                    if (match.Result === 'A') stats[awayTeam].awayWins++;
                    else if (match.Result === 'D') stats[awayTeam].awayDraws++;
                    else stats[awayTeam].awayLosses++;
                });
                
                return Object.values(stats).map(team => ({
                    ...team,
                    homePoints: team.homeWins * 3 + team.homeDraws,
                    awayPoints: team.awayWins * 3 + team.awayDraws,
                    homeAvgGF: team.homeGames > 0 ? (team.homeGF / team.homeGames).toFixed(2) : '0.00',
                    homeAvgGA: team.homeGames > 0 ? (team.homeGA / team.homeGames).toFixed(2) : '0.00',
                    awayAvgGF: team.awayGames > 0 ? (team.awayGF / team.awayGames).toFixed(2) : '0.00',
                    awayAvgGA: team.awayGames > 0 ? (team.awayGA / team.awayGames).toFixed(2) : '0.00',
                    homeWinRate: team.homeGames > 0 ? ((team.homeWins / team.homeGames) * 100).toFixed(1) : '0.0',
                    awayWinRate: team.awayGames > 0 ? ((team.awayWins / team.awayGames) * 100).toFixed(1) : '0.0',
                    homeGD: team.homeGF - team.homeGA,
                    awayGD: team.awayGF - team.awayGA
                }));
            }, [matches]);
            const currentGiornata = useMemo(() => { const played = matches.filter(m => m.HGoals !== ''); return played.length === 0 ? 1 : Math.max(...played.map(m => parseInt(m.Date))); }, [matches]);
            const matchdayMatches = useMemo(() => matches.filter(m => parseInt(m.Date) === (selectedGiornata || currentGiornata)), [matches, selectedGiornata, currentGiornata]);
            const matchdayPointsMatches = useMemo(() => pointsMatches.filter(m => parseInt(m.Date) === (selectedGiornata || currentGiornata)), [pointsMatches, selectedGiornata, currentGiornata]);

            const tabs = [
                { id: 'standings', label: 'Classifica', icon: Icons.Trophy },
                { id: 'stats', label: 'Statistiche', icon: Icons.BarChart },
                { id: 'homeaway', label: 'Casa/Trasferta', icon: Icons.Activity },
                { id: 'ratings', label: 'Valutazioni', icon: Icons.Zap },
                { id: 'points', label: 'Punti Fanta', icon: Icons.Calculator },
                { id: 'calendar', label: 'Calendario', icon: Icons.Calendar },
                { id: 'simulator', label: 'Simulazione', icon: Icons.Target },
                { id: 'coachstats', label: 'Coach Stats', icon: Icons.Shield },
                { id: 'toolculo', label: 'Tool Culo', icon: Icons.Zap },
            ];

            return (
                <div className="min-h-screen">
                    <div className="fixed inset-0 overflow-hidden pointer-events-none">
                        <div className="absolute top-0 left-1/4 w-[500px] h-[500px] bg-emerald-500/10 rounded-full blur-[100px]" />
                        <div className="absolute bottom-0 right-1/4 w-[500px] h-[500px] bg-blue-500/10 rounded-full blur-[100px]" />
                    </div>

                    <header className="relative border-b border-white/10 glass">
                        <div className="max-w-7xl mx-auto px-6 py-6">
                            <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                                <div className="flex items-center gap-4">
                                    <div className="w-14 h-14 bg-gradient-to-br from-emerald-400 to-emerald-600 rounded-2xl flex items-center justify-center shadow-lg glow-green"><Icons.Trophy /></div>
                                    <div>
                                        <h1 className="text-2xl font-bold tracking-tight">FantaSmegma League</h1>
                                        <p className="text-slate-400 text-sm">Stagione 2025/26 â€¢ Giornata {currentGiornata}/36</p>
                                    </div>
                                </div>
                                    <div className="flex flex-wrap items-center gap-3">
                                        <div className="flex flex-col gap-1">
                                            <label className="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 rounded-lg cursor-pointer transition-all text-sm">
                                                <Icons.Upload /><span className="font-medium">CSV Gol</span>
                                                <input type="file" accept=".csv" onChange={handleGoalsUpload} className="hidden" />
                                            </label>
                                            {uploadStatus && <span className="text-xs text-emerald-400">{uploadStatus}</span>}
                                        </div>
                                        <div className="flex flex-col gap-1">
                                            <label className="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 rounded-lg cursor-pointer transition-all text-sm">
                                                <Icons.Upload /><span className="font-medium">CSV Punti</span>
                                                <input type="file" accept=".csv" onChange={handlePointsUpload} className="hidden" />
                                            </label>
                                            {pointsUploadStatus && <span className="text-xs text-blue-400">{pointsUploadStatus}</span>}
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </header>

                    <nav className="relative border-b border-white/10 glass sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-6">
                            <div className="flex gap-1 overflow-x-auto scrollbar-thin">
                                {tabs.map((tab) => {
                                    const Icon = tab.icon;
                                    return (
                                        <button key={tab.id} onClick={() => setActiveTab(tab.id)}
                                            className={`flex items-center gap-2 px-5 py-4 font-medium transition-all relative whitespace-nowrap ${activeTab === tab.id ? 'text-emerald-400' : 'text-slate-400 hover:text-white'}`}>
                                            <Icon />{tab.label}
                                            {activeTab === tab.id && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-gradient-to-r from-emerald-400 to-emerald-600" />}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </nav>

                    <main className="relative max-w-7xl mx-auto px-6 py-8">
                        {activeTab === 'standings' && (
                            <div className="space-y-6">
                                <div>
                                    <h2 className="text-xl font-bold">Classifica Generale</h2>
                                    <p className="text-slate-400 text-sm mt-1">Classifica ufficiale basata sui risultati delle partite (3 punti vittoria, 1 pareggio)</p>
                                </div>
                                
                                {/* Legend */}
                                <div className="glass rounded-xl p-4">
                                    <h3 className="text-sm font-semibold text-slate-300 mb-3">ðŸ“– Legenda Colonne</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-5 gap-3 text-xs text-slate-400">
                                        <div><span className="text-white font-medium">P</span> = Partite giocate</div>
                                        <div><span className="text-emerald-400 font-medium">V</span> = Vittorie</div>
                                        <div><span className="text-amber-400 font-medium">N</span> = Pareggi</div>
                                        <div><span className="text-red-400 font-medium">S</span> = Sconfitte</div>
                                        <div><span className="text-white font-medium">GF</span> = Gol Fatti</div>
                                        <div><span className="text-white font-medium">GS</span> = Gol Subiti</div>
                                        <div><span className="text-white font-medium">Pts</span> = Punti classifica</div>
                                        <div><span className="text-white font-medium">Forma</span> = Ultime 5 partite</div>
                                    </div>
                                </div>
                                
                                <div className="glass rounded-2xl overflow-hidden">
                                    <div className="hidden md:grid grid-cols-12 gap-4 px-6 py-4 bg-white/5 text-sm font-medium text-slate-400">
                                        <div className="col-span-1">#</div><div className="col-span-3">Squadra</div><div className="col-span-1 text-center">P</div><div className="col-span-1 text-center">V</div><div className="col-span-1 text-center">N</div><div className="col-span-1 text-center">S</div><div className="col-span-1 text-center">GF</div><div className="col-span-1 text-center">GS</div><div className="col-span-1 text-center">Pts</div><div className="col-span-1 text-center">Forma</div>
                                    </div>
                                    {standings.map((team, index) => (
                                        <div key={team.team} className={`grid grid-cols-12 gap-4 px-6 py-4 items-center transition-all hover:bg-white/5 border-t border-white/5 ${index < 1 ? 'border-l-2 border-l-amber-500' : ''} ${index >= standings.length - 1 ? 'border-l-2 border-l-red-500' : ''}`}>
                                            <div className="col-span-2 md:col-span-1">
                                                <span className={`inline-flex items-center justify-center w-8 h-8 rounded-lg font-bold text-sm ${index === 0 ? 'bg-gradient-to-br from-amber-400 to-amber-600 text-slate-900' : index === 1 ? 'bg-gradient-to-br from-slate-300 to-slate-400 text-slate-900' : index === 2 ? 'bg-gradient-to-br from-orange-400 to-orange-600 text-white' : 'bg-white/10 text-white'}`}>{index + 1}</span>
                                            </div>
                                            <div className="col-span-10 md:col-span-3"><p className="font-semibold truncate">{team.team}</p></div>
                                            <div className="hidden md:block col-span-1 text-center text-slate-300">{team.played}</div>
                                            <div className="hidden md:block col-span-1 text-center font-medium text-emerald-400">{team.wins}</div>
                                            <div className="hidden md:block col-span-1 text-center font-medium text-amber-400">{team.draws}</div>
                                            <div className="hidden md:block col-span-1 text-center font-medium text-red-400">{team.losses}</div>
                                            <div className="hidden md:block col-span-1 text-center text-slate-300">{team.goalsFor}</div>
                                            <div className="hidden md:block col-span-1 text-center text-slate-300">{team.goalsAgainst}</div>
                                            <div className="hidden md:block col-span-1 text-center"><span className="text-xl font-bold text-white">{team.points}</span></div>
                                            <div className="hidden md:flex col-span-1 justify-center gap-1">{team.form.slice(-5).map((result, i) => <FormBadge key={i} result={result} />)}</div>
                                            <div className="col-span-12 md:hidden flex items-center justify-between text-sm mt-2 pt-2 border-t border-white/5">
                                                <div className="flex gap-3"><span className="text-emerald-400">V:{team.wins}</span><span className="text-amber-400">N:{team.draws}</span><span className="text-red-400">S:{team.losses}</span></div>
                                                <span className="text-xl font-bold">{team.points} pts</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'stats' && (
                            <div className="space-y-6">
                                <div>
                                    <h2 className="text-xl font-bold">Statistiche Squadre (Gol)</h2>
                                    <p className="text-slate-400 text-sm mt-1">Analisi delle prestazioni offensive e difensive basate sui gol segnati e subiti</p>
                                </div>
                                
                                {/* Legend */}
                                <div className="glass rounded-xl p-4">
                                    <h3 className="text-sm font-semibold text-slate-300 mb-3">ðŸ“– Legenda Statistiche</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-400">
                                        <div><span className="text-emerald-400 font-medium">Attacco</span> = Media gol fatti / Media lega ({">"} 1.00 = sopra media)</div>
                                        <div><span className="text-blue-400 font-medium">Difesa</span> = Media lega subiti / Media subiti ({">"} 1.00 = sopra media)</div>
                                        <div><span className="text-white font-medium">Media GF</span> = Gol fatti per partita</div>
                                        <div><span className="text-white font-medium">Media GS</span> = Gol subiti per partita</div>
                                        <div><span className="text-white font-medium">DR</span> = Differenza reti totale</div>
                                        <div><span className="text-white font-medium">Vitt %</span> = Percentuale vittorie</div>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="glass rounded-2xl p-5">
                                        <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-emerald-500/20 rounded-xl flex items-center justify-center text-emerald-400"><Icons.Target /></div><div><p className="text-slate-400 text-sm">Miglior Attacco</p><p className="font-bold">Rating Attacco</p></div></div>
                                        <div className="space-y-2">{[...teamStats].sort((a,b) => parseFloat(b.attackRating) - parseFloat(a.attackRating)).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-emerald-400">{team.attackRating}</span></div>)}</div>
                                    </div>
                                    <div className="glass rounded-2xl p-5">
                                        <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center text-blue-400"><Icons.Shield /></div><div><p className="text-slate-400 text-sm">Miglior Difesa</p><p className="font-bold">Rating Difesa</p></div></div>
                                        <div className="space-y-2">{[...teamStats].sort((a,b) => parseFloat(b.defenseRating) - parseFloat(a.defenseRating)).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-blue-400">{team.defenseRating}</span></div>)}</div>
                                    </div>
                                    <div className="glass rounded-2xl p-5">
                                        <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-purple-500/20 rounded-xl flex items-center justify-center text-purple-400"><Icons.Zap /></div><div><p className="text-slate-400 text-sm">Differenza Reti</p><p className="font-bold">Miglior DR</p></div></div>
                                        <div className="space-y-2">{[...teamStats].sort((a,b) => b.goalDiff - a.goalDiff).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-purple-400">{team.goalDiff > 0 ? '+' : ''}{team.goalDiff}</span></div>)}</div>
                                    </div>
                                    <div className="glass rounded-2xl p-5">
                                        <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-amber-500/20 rounded-xl flex items-center justify-center text-amber-400"><Icons.Trophy /></div><div><p className="text-slate-400 text-sm">PiÃ¹ Dominante</p><p className="font-bold">% Vittorie</p></div></div>
                                        <div className="space-y-2">{[...teamStats].sort((a,b) => b.winRate - a.winRate).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-amber-400">{team.winRate}%</span></div>)}</div>
                                    </div>
                                </div>
                                <div className="glass rounded-2xl overflow-hidden">
                                    <div className="px-6 py-4 bg-white/5 border-b border-white/10"><h3 className="font-bold">Statistiche Complete</h3><p className="text-sm text-slate-400">Clicca sulle intestazioni per ordinare â€¢ Rating: &gt;1 = sopra media, &lt;1 = sotto media</p></div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead><tr className="text-sm text-slate-400 border-b border-white/10">
                                                <th className="px-6 py-3 text-left cursor-pointer hover:text-white transition-colors" onClick={() => handleTeamStatsSort('team')}>Squadra<SortIcon column="team" current={teamStatsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleTeamStatsSort('attackRating')}>Attacco<SortIcon column="attackRating" current={teamStatsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleTeamStatsSort('defenseRating')}>Difesa<SortIcon column="defenseRating" current={teamStatsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleTeamStatsSort('avgFor')}>Media GF<SortIcon column="avgFor" current={teamStatsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleTeamStatsSort('avgAgainst')}>Media GS<SortIcon column="avgAgainst" current={teamStatsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleTeamStatsSort('goalDiff')}>DR<SortIcon column="goalDiff" current={teamStatsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleTeamStatsSort('winRate')}>Vitt %<SortIcon column="winRate" current={teamStatsSort} /></th>
                                            </tr></thead>
                                            <tbody>{[...teamStats].sort((a, b) => {
                                                const aVal = teamStatsSort.column === 'team' ? a.team : parseFloat(a[teamStatsSort.column]) || 0;
                                                const bVal = teamStatsSort.column === 'team' ? b.team : parseFloat(b[teamStatsSort.column]) || 0;
                                                if (teamStatsSort.column === 'team') {
                                                    return teamStatsSort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                                                }
                                                return teamStatsSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                                            }).map((team) => (
                                                <tr key={team.team} className="border-b border-white/5 hover:bg-white/5">
                                                    <td className="px-6 py-4 font-medium">{team.team}</td>
                                                    <td className="px-4 py-4 text-center"><span className={`font-bold ${parseFloat(team.attackRating) >= 1 ? 'text-emerald-400' : 'text-red-400'}`}>{team.attackRating}</span></td>
                                                    <td className="px-4 py-4 text-center"><span className={`font-bold ${parseFloat(team.defenseRating) >= 1 ? 'text-blue-400' : 'text-red-400'}`}>{team.defenseRating}</span></td>
                                                    <td className="px-4 py-4 text-center text-emerald-400 font-medium">{team.avgFor}</td>
                                                    <td className="px-4 py-4 text-center text-red-400 font-medium">{team.avgAgainst}</td>
                                                    <td className="px-4 py-4 text-center"><span className={`font-bold ${team.goalDiff > 0 ? 'text-emerald-400' : team.goalDiff < 0 ? 'text-red-400' : 'text-slate-400'}`}>{team.goalDiff > 0 ? '+' : ''}{team.goalDiff}</span></td>
                                                    <td className="px-4 py-4 text-center font-medium">{team.winRate}%</td>
                                                </tr>
                                            ))}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'homeaway' && (
                            <div className="space-y-6">
                                <div>
                                    <h2 className="text-xl font-bold">Statistiche Casa e Trasferta</h2>
                                    <p className="text-slate-400 text-sm mt-1">Confronto delle prestazioni giocando in casa vs in trasferta</p>
                                </div>
                                
                                {/* Legend */}
                                <div className="glass rounded-xl p-4">
                                    <h3 className="text-sm font-semibold text-slate-300 mb-3">ðŸ“– Legenda Colonne</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs text-slate-400">
                                        <div><span className="text-white font-medium">P</span> = Partite giocate</div>
                                        <div><span className="text-emerald-400 font-medium">V</span> = Vittorie</div>
                                        <div><span className="text-amber-400 font-medium">N</span> = Pareggi</div>
                                        <div><span className="text-red-400 font-medium">S</span> = Sconfitte</div>
                                        <div><span className="text-white font-medium">GF</span> = Gol fatti</div>
                                        <div><span className="text-white font-medium">GS</span> = Gol subiti</div>
                                        <div><span className="text-white font-medium">DR</span> = Differenza reti</div>
                                        <div><span className="text-white font-medium">Vitt%</span> = % vittorie</div>
                                    </div>
                                </div>
                                
                                {/* Summary Cards */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="glass rounded-2xl p-5">
                                        <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-emerald-500/20 rounded-xl flex items-center justify-center text-emerald-400"><Icons.Trophy /></div><div><p className="text-slate-400 text-sm">Migliore in Casa</p><p className="font-bold">% Vittorie Casa</p></div></div>
                                        <div className="space-y-2">{[...homeAwayStats].sort((a,b) => parseFloat(b.homeWinRate) - parseFloat(a.homeWinRate)).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-emerald-400">{team.homeWinRate}%</span></div>)}</div>
                                    </div>
                                    <div className="glass rounded-2xl p-5">
                                        <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center text-blue-400"><Icons.TrendingUp /></div><div><p className="text-slate-400 text-sm">Migliore Fuori</p><p className="font-bold">% Vittorie Trasf.</p></div></div>
                                        <div className="space-y-2">{[...homeAwayStats].sort((a,b) => parseFloat(b.awayWinRate) - parseFloat(a.awayWinRate)).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-blue-400">{team.awayWinRate}%</span></div>)}</div>
                                    </div>
                                    <div className="glass rounded-2xl p-5">
                                        <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-amber-500/20 rounded-xl flex items-center justify-center text-amber-400"><Icons.Target /></div><div><p className="text-slate-400 text-sm">Attacco Casa</p><p className="font-bold">Media Gol Casa</p></div></div>
                                        <div className="space-y-2">{[...homeAwayStats].sort((a,b) => parseFloat(b.homeAvgGF) - parseFloat(a.homeAvgGF)).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-amber-400">{team.homeAvgGF}</span></div>)}</div>
                                    </div>
                                    <div className="glass rounded-2xl p-5">
                                        <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-purple-500/20 rounded-xl flex items-center justify-center text-purple-400"><Icons.Shield /></div><div><p className="text-slate-400 text-sm">Difesa Trasferta</p><p className="font-bold">Media Subiti Trasf.</p></div></div>
                                        <div className="space-y-2">{[...homeAwayStats].sort((a,b) => parseFloat(a.awayAvgGA) - parseFloat(b.awayAvgGA)).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-purple-400">{team.awayAvgGA}</span></div>)}</div>
                                    </div>
                                </div>

                                {/* Home Stats Table */}
                                <div className="glass rounded-2xl overflow-hidden">
                                    <div className="px-6 py-4 bg-emerald-500/10 border-b border-white/10"><h3 className="font-bold text-emerald-400">ðŸ  Statistiche Casa</h3><p className="text-sm text-slate-400">Clicca sulle intestazioni per ordinare</p></div>
                                    <div className="overflow-x-auto scrollbar-thin">
                                        <table className="w-full">
                                            <thead><tr className="text-sm text-slate-400 border-b border-white/10">
                                                <th className="px-6 py-3 text-left cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('team')}>Squadra<SortIcon column="team" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('homeGames')}>P<SortIcon column="homeGames" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('homeWins')}>V<SortIcon column="homeWins" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('homeDraws')}>N<SortIcon column="homeDraws" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('homeLosses')}>S<SortIcon column="homeLosses" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('homeGF')}>GF<SortIcon column="homeGF" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('homeGA')}>GS<SortIcon column="homeGA" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('homeGD')}>DR<SortIcon column="homeGD" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('homeAvgGF')}>Media GF<SortIcon column="homeAvgGF" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('homeAvgGA')}>Media GS<SortIcon column="homeAvgGA" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('homePoints')}>Pts<SortIcon column="homePoints" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('homeWinRate')}>Vitt%<SortIcon column="homeWinRate" current={homeAwaySort} /></th>
                                            </tr></thead>
                                            <tbody>{[...homeAwayStats].sort((a, b) => {
                                                const aVal = homeAwaySort.column === 'team' ? a.team : parseFloat(a[homeAwaySort.column]) || 0;
                                                const bVal = homeAwaySort.column === 'team' ? b.team : parseFloat(b[homeAwaySort.column]) || 0;
                                                if (homeAwaySort.column === 'team') return homeAwaySort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                                                return homeAwaySort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                                            }).map((team) => (
                                                <tr key={team.team} className="border-b border-white/5 hover:bg-white/5">
                                                    <td className="px-6 py-4 font-medium">{team.team}</td>
                                                    <td className="px-4 py-4 text-center text-slate-300">{team.homeGames}</td>
                                                    <td className="px-4 py-4 text-center text-emerald-400 font-medium">{team.homeWins}</td>
                                                    <td className="px-4 py-4 text-center text-amber-400 font-medium">{team.homeDraws}</td>
                                                    <td className="px-4 py-4 text-center text-red-400 font-medium">{team.homeLosses}</td>
                                                    <td className="px-4 py-4 text-center text-slate-300">{team.homeGF}</td>
                                                    <td className="px-4 py-4 text-center text-slate-300">{team.homeGA}</td>
                                                    <td className="px-4 py-4 text-center"><span className={`font-bold ${team.homeGD > 0 ? 'text-emerald-400' : team.homeGD < 0 ? 'text-red-400' : 'text-slate-400'}`}>{team.homeGD > 0 ? '+' : ''}{team.homeGD}</span></td>
                                                    <td className="px-4 py-4 text-center text-emerald-400">{team.homeAvgGF}</td>
                                                    <td className="px-4 py-4 text-center text-red-400">{team.homeAvgGA}</td>
                                                    <td className="px-4 py-4 text-center font-bold">{team.homePoints}</td>
                                                    <td className="px-4 py-4 text-center font-bold text-emerald-400">{team.homeWinRate}%</td>
                                                </tr>
                                            ))}</tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Away Stats Table */}
                                <div className="glass rounded-2xl overflow-hidden">
                                    <div className="px-6 py-4 bg-blue-500/10 border-b border-white/10"><h3 className="font-bold text-blue-400">âœˆï¸ Statistiche Trasferta</h3><p className="text-sm text-slate-400">Clicca sulle intestazioni per ordinare</p></div>
                                    <div className="overflow-x-auto scrollbar-thin">
                                        <table className="w-full">
                                            <thead><tr className="text-sm text-slate-400 border-b border-white/10">
                                                <th className="px-6 py-3 text-left cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('team')}>Squadra<SortIcon column="team" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('awayGames')}>P<SortIcon column="awayGames" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('awayWins')}>V<SortIcon column="awayWins" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('awayDraws')}>N<SortIcon column="awayDraws" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('awayLosses')}>S<SortIcon column="awayLosses" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('awayGF')}>GF<SortIcon column="awayGF" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('awayGA')}>GS<SortIcon column="awayGA" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('awayGD')}>DR<SortIcon column="awayGD" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('awayAvgGF')}>Media GF<SortIcon column="awayAvgGF" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('awayAvgGA')}>Media GS<SortIcon column="awayAvgGA" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('awayPoints')}>Pts<SortIcon column="awayPoints" current={homeAwaySort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handleHomeAwaySort('awayWinRate')}>Vitt%<SortIcon column="awayWinRate" current={homeAwaySort} /></th>
                                            </tr></thead>
                                            <tbody>{[...homeAwayStats].sort((a, b) => {
                                                const aVal = homeAwaySort.column === 'team' ? a.team : parseFloat(a[homeAwaySort.column]) || 0;
                                                const bVal = homeAwaySort.column === 'team' ? b.team : parseFloat(b[homeAwaySort.column]) || 0;
                                                if (homeAwaySort.column === 'team') return homeAwaySort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                                                return homeAwaySort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                                            }).map((team) => (
                                                <tr key={team.team} className="border-b border-white/5 hover:bg-white/5">
                                                    <td className="px-6 py-4 font-medium">{team.team}</td>
                                                    <td className="px-4 py-4 text-center text-slate-300">{team.awayGames}</td>
                                                    <td className="px-4 py-4 text-center text-emerald-400 font-medium">{team.awayWins}</td>
                                                    <td className="px-4 py-4 text-center text-amber-400 font-medium">{team.awayDraws}</td>
                                                    <td className="px-4 py-4 text-center text-red-400 font-medium">{team.awayLosses}</td>
                                                    <td className="px-4 py-4 text-center text-slate-300">{team.awayGF}</td>
                                                    <td className="px-4 py-4 text-center text-slate-300">{team.awayGA}</td>
                                                    <td className="px-4 py-4 text-center"><span className={`font-bold ${team.awayGD > 0 ? 'text-emerald-400' : team.awayGD < 0 ? 'text-red-400' : 'text-slate-400'}`}>{team.awayGD > 0 ? '+' : ''}{team.awayGD}</span></td>
                                                    <td className="px-4 py-4 text-center text-emerald-400">{team.awayAvgGF}</td>
                                                    <td className="px-4 py-4 text-center text-red-400">{team.awayAvgGA}</td>
                                                    <td className="px-4 py-4 text-center font-bold">{team.awayPoints}</td>
                                                    <td className="px-4 py-4 text-center font-bold text-blue-400">{team.awayWinRate}%</td>
                                                </tr>
                                            ))}</tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'ratings' && (
                            <div className="space-y-6">
                                <div>
                                    <h2 className="text-xl font-bold">Valutazioni e Classifiche</h2>
                                    <p className="text-slate-400 text-sm mt-1">Sistemi di rating multipli calcolati dai risultati. Clicca sulle intestazioni per ordinare.</p>
                                </div>
                                
                                {/* Legend */}
                                <div className="glass rounded-xl p-4">
                                    <h3 className="text-sm font-semibold text-slate-300 mb-3">ðŸ“– Spiegazione Sistemi di Rating</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-400">
                                        <div><span className="text-amber-400 font-medium">ELO</span> = Sistema scacchi adattato (1500 base, K=21)</div>
                                        <div><span className="text-emerald-400 font-medium">Pi</span> = Rating attacco/difesa combinato iterativo</div>
                                        <div><span className="text-blue-400 font-medium">Massey</span> = Minimi quadrati sulle differenze gol</div>
                                        <div><span className="text-purple-400 font-medium">Colley</span> = Bayesiano (0.5 = media)</div>
                                        <div><span className="text-pink-400 font-medium">SPI</span> = Indice potenza calcio (attacco/difesa)</div>
                                        <div><span className="text-cyan-400 font-medium">SOS</span> = Forza calendario (media avversari)</div>
                                        <div><span className="text-orange-400 font-medium">Keener</span> = Autovettori, normalizzato a 100</div>
                                        <div><span className="text-red-400 font-medium">B-T</span> = Bradley-Terry probabilistico</div>
                                    </div>
                                </div>
                                
                                {/* Rating System Explanations */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="glass rounded-xl p-4">
                                        <h4 className="font-bold text-amber-400 mb-1">ELO (K=21)</h4>
                                        <p className="text-xs text-slate-400">Rating stile scacchi. Vittoria vs squadra forte = piÃ¹ punti. Base: 1500</p>
                                    </div>
                                    <div className="glass rounded-xl p-4">
                                        <h4 className="font-bold text-emerald-400 mb-1">Pi Rating</h4>
                                        <p className="text-xs text-slate-400">Rating attacco/difesa basato su gol fatti vs attesi.</p>
                                    </div>
                                    <div className="glass rounded-xl p-4">
                                        <h4 className="font-bold text-blue-400 mb-1">Massey</h4>
                                        <p className="text-xs text-slate-400">Least squares ranking based on point differentials.</p>
                                    </div>
                                    <div className="glass rounded-xl p-4">
                                        <h4 className="font-bold text-purple-400 mb-1">Colley</h4>
                                        <p className="text-xs text-slate-400">Rating bayesiano usando vittorie/sconfitte. 0.5 = media.</p>
                                    </div>
                                    <div className="glass rounded-xl p-4">
                                        <h4 className="font-bold text-pink-400 mb-1">SPI</h4>
                                        <p className="text-xs text-slate-400">Indice Potenza Calcio: rapporto forza attacco/difesa.</p>
                                    </div>
                                    <div className="glass rounded-xl p-4">
                                        <h4 className="font-bold text-cyan-400 mb-1">SOS</h4>
                                        <p className="text-xs text-slate-400">Forza Calendario: forza media degli avversari affrontati.</p>
                                    </div>
                                    <div className="glass rounded-xl p-4">
                                        <h4 className="font-bold text-orange-400 mb-1">Keener</h4>
                                        <p className="text-xs text-slate-400">Rating basato su autovettori dai margini partita.</p>
                                    </div>
                                    <div className="glass rounded-xl p-4">
                                        <h4 className="font-bold text-red-400 mb-1">Bradley-Terry</h4>
                                        <p className="text-xs text-slate-400">Modello confronto a coppie probabilistico. 1.0 = media.</p>
                                    </div>
                                </div>

                                {/* Ratings Table */}
                                <div className="glass rounded-2xl overflow-hidden">
                                    <div className="px-6 py-4 bg-white/5 border-b border-white/10">
                                        <h3 className="font-bold">Confronto Valutazioni</h3>
                                    </div>
                                    <div className="overflow-x-auto scrollbar-thin">
                                        <table className="w-full">
                                            <thead><tr className="text-sm text-slate-400 border-b border-white/10">
                                                <th className="px-6 py-3 text-left cursor-pointer hover:text-white transition-colors" onClick={() => handleRatingsSort('team')}>Squadra<SortIcon column="team" current={ratingsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-amber-400 transition-colors" onClick={() => handleRatingsSort('elo')}>ELO<SortIcon column="elo" current={ratingsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-emerald-400 transition-colors" onClick={() => handleRatingsSort('pi')}>Pi<SortIcon column="pi" current={ratingsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-blue-400 transition-colors" onClick={() => handleRatingsSort('massey')}>Massey<SortIcon column="massey" current={ratingsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-purple-400 transition-colors" onClick={() => handleRatingsSort('colley')}>Colley<SortIcon column="colley" current={ratingsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-pink-400 transition-colors" onClick={() => handleRatingsSort('spi')}>SPI<SortIcon column="spi" current={ratingsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-cyan-400 transition-colors" onClick={() => handleRatingsSort('sos')}>SOS<SortIcon column="sos" current={ratingsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-orange-400 transition-colors" onClick={() => handleRatingsSort('keener')}>Keener<SortIcon column="keener" current={ratingsSort} /></th>
                                                <th className="px-4 py-3 text-center cursor-pointer hover:text-red-400 transition-colors" onClick={() => handleRatingsSort('bt')}>B-T<SortIcon column="bt" current={ratingsSort} /></th>
                                            </tr></thead>
                                            <tbody>{[...allRatings].sort((a, b) => {
                                                const aVal = ratingsSort.column === 'team' ? a.team : parseFloat(a[ratingsSort.column]) || 0;
                                                const bVal = ratingsSort.column === 'team' ? b.team : parseFloat(b[ratingsSort.column]) || 0;
                                                if (ratingsSort.column === 'team') return ratingsSort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                                                return ratingsSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                                            }).map((team, idx) => (
                                                <tr key={team.team} className="border-b border-white/5 hover:bg-white/5">
                                                    <td className="px-6 py-4 font-medium">{team.team}</td>
                                                    <td className="px-4 py-4 text-center"><span className={`font-bold ${parseFloat(team.elo) >= 1500 ? 'text-amber-400' : 'text-slate-400'}`}>{team.elo}</span></td>
                                                    <td className="px-4 py-4 text-center"><span className={`font-bold ${parseFloat(team.pi) >= 1 ? 'text-emerald-400' : 'text-slate-400'}`}>{team.pi}</span></td>
                                                    <td className="px-4 py-4 text-center"><span className={`font-bold ${parseFloat(team.massey) >= 0 ? 'text-blue-400' : 'text-red-400'}`}>{team.massey}</span></td>
                                                    <td className="px-4 py-4 text-center"><span className={`font-bold ${parseFloat(team.colley) >= 0.5 ? 'text-purple-400' : 'text-slate-400'}`}>{team.colley}</span></td>
                                                    <td className="px-4 py-4 text-center"><span className={`font-bold ${parseFloat(team.spi) >= 1 ? 'text-pink-400' : 'text-slate-400'}`}>{team.spi}</span></td>
                                                    <td className="px-4 py-4 text-center"><span className="font-bold text-cyan-400">{team.sos}</span></td>
                                                    <td className="px-4 py-4 text-center"><span className="font-bold text-orange-400">{team.keener}</span></td>
                                                    <td className="px-4 py-4 text-center"><span className={`font-bold ${parseFloat(team.bt) >= 1 ? 'text-red-400' : 'text-slate-400'}`}>{team.bt}</span></td>
                                                </tr>
                                            ))}</tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Top Rated by Each System */}
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="glass rounded-2xl p-5">
                                        <h4 className="font-bold text-amber-400 mb-3">Top ELO</h4>
                                        <div className="space-y-2">{[...allRatings].sort((a,b) => b.elo - a.elo).slice(0,3).map((t,i) => (
                                            <div key={t.team} className="flex justify-between"><span className="text-sm truncate max-w-[120px]">{i+1}. {t.team}</span><span className="font-bold text-amber-400">{t.elo}</span></div>
                                        ))}</div>
                                    </div>
                                    <div className="glass rounded-2xl p-5">
                                        <h4 className="font-bold text-blue-400 mb-3">Top Massey</h4>
                                        <div className="space-y-2">{[...allRatings].sort((a,b) => parseFloat(b.massey) - parseFloat(a.massey)).slice(0,3).map((t,i) => (
                                            <div key={t.team} className="flex justify-between"><span className="text-sm truncate max-w-[120px]">{i+1}. {t.team}</span><span className="font-bold text-blue-400">{t.massey}</span></div>
                                        ))}</div>
                                    </div>
                                    <div className="glass rounded-2xl p-5">
                                        <h4 className="font-bold text-purple-400 mb-3">Top Colley</h4>
                                        <div className="space-y-2">{[...allRatings].sort((a,b) => parseFloat(b.colley) - parseFloat(a.colley)).slice(0,3).map((t,i) => (
                                            <div key={t.team} className="flex justify-between"><span className="text-sm truncate max-w-[120px]">{i+1}. {t.team}</span><span className="font-bold text-purple-400">{t.colley}</span></div>
                                        ))}</div>
                                    </div>
                                    <div className="glass rounded-2xl p-5">
                                        <h4 className="font-bold text-red-400 mb-3">Top Bradley-Terry</h4>
                                        <div className="space-y-2">{[...allRatings].sort((a,b) => parseFloat(b.bt) - parseFloat(a.bt)).slice(0,3).map((t,i) => (
                                            <div key={t.team} className="flex justify-between"><span className="text-sm truncate max-w-[120px]">{i+1}. {t.team}</span><span className="font-bold text-red-400">{t.bt}</span></div>
                                        ))}</div>
                                    </div>
                                </div>

                                {/* Consensus Ranking */}
                                <div className="glass rounded-2xl p-6">
                                    <h3 className="font-bold mb-4">Classifica Consenso</h3>
                                    <p className="text-slate-400 text-sm mb-4">Media posizioni in tutti i sistemi</p>
                                    <div className="space-y-3">
                                        {(() => {
                                            const rankings = allRatings.map(team => {
                                                const eloRank = [...allRatings].sort((a,b) => b.elo - a.elo).findIndex(t => t.team === team.team) + 1;
                                                const piRank = [...allRatings].sort((a,b) => parseFloat(b.pi) - parseFloat(a.pi)).findIndex(t => t.team === team.team) + 1;
                                                const masseyRank = [...allRatings].sort((a,b) => parseFloat(b.massey) - parseFloat(a.massey)).findIndex(t => t.team === team.team) + 1;
                                                const colleyRank = [...allRatings].sort((a,b) => parseFloat(b.colley) - parseFloat(a.colley)).findIndex(t => t.team === team.team) + 1;
                                                const spiRank = [...allRatings].sort((a,b) => parseFloat(b.spi) - parseFloat(a.spi)).findIndex(t => t.team === team.team) + 1;
                                                const keenerRank = [...allRatings].sort((a,b) => parseFloat(b.keener) - parseFloat(a.keener)).findIndex(t => t.team === team.team) + 1;
                                                const btRank = [...allRatings].sort((a,b) => parseFloat(b.bt) - parseFloat(a.bt)).findIndex(t => t.team === team.team) + 1;
                                                const avgRank = (eloRank + piRank + masseyRank + colleyRank + spiRank + keenerRank + btRank) / 7;
                                                return { ...team, avgRank: avgRank.toFixed(2) };
                                            }).sort((a, b) => parseFloat(a.avgRank) - parseFloat(b.avgRank));
                                            
                                            return rankings.map((team, idx) => (
                                                <div key={team.team} className="flex items-center gap-4">
                                                    <span className={`w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm ${idx === 0 ? 'bg-amber-500 text-slate-900' : idx === 1 ? 'bg-slate-300 text-slate-900' : idx === 2 ? 'bg-orange-500 text-white' : 'bg-white/10'}`}>{idx + 1}</span>
                                                    <span className="font-medium flex-1">{team.team}</span>
                                                    <span className="text-slate-400 text-sm">Pos. Media:</span>
                                                    <span className="font-bold text-emerald-400">{team.avgRank}</span>
                                                </div>
                                            ));
                                        })()}
                                    </div>
                                </div>

                                {/* Classifica Ensemble */}
                                <div className="glass rounded-2xl p-6">
                                    <h3 className="font-bold mb-2 flex items-center gap-2"><Icons.Zap /> Classifica Ensemble</h3>
                                    <p className="text-slate-400 text-sm mb-4">Combinazione pesata di tutti gli 8 sistemi, normalizzata 0-100</p>
                                    
                                    {(() => {
                                        // Normalize each rating to 0-1 scale, then combine
                                        const normalize = (arr, key, inverse = false) => {
                                            const values = arr.map(t => parseFloat(t[key]) || 0);
                                            const min = Math.min(...values);
                                            const max = Math.max(...values);
                                            const range = max - min || 1;
                                            return arr.map(t => {
                                                const norm = (parseFloat(t[key]) - min) / range;
                                                return inverse ? 1 - norm : norm;
                                            });
                                        };
                                        
                                        const eloNorm = normalize(allRatings, 'elo');
                                        const piNorm = normalize(allRatings, 'pi');
                                        const masseyNorm = normalize(allRatings, 'massey');
                                        const colleyNorm = normalize(allRatings, 'colley');
                                        const spiNorm = normalize(allRatings, 'spi');
                                        const sosNorm = normalize(allRatings, 'sos'); // Higher SOS = harder schedule
                                        const keenerNorm = normalize(allRatings, 'keener');
                                        const btNorm = normalize(allRatings, 'bt');
                                        
                                        // Weights for each system (can be adjusted)
                                        const weights = {
                                            elo: 0.15,
                                            pi: 0.10,
                                            massey: 0.15,
                                            colley: 0.15,
                                            spi: 0.10,
                                            sos: 0.10,
                                            keener: 0.10,
                                            bt: 0.15
                                        };
                                        
                                        const ensembleScores = allRatings.map((team, i) => {
                                            const score = (
                                                eloNorm[i] * weights.elo +
                                                piNorm[i] * weights.pi +
                                                masseyNorm[i] * weights.massey +
                                                colleyNorm[i] * weights.colley +
                                                spiNorm[i] * weights.spi +
                                                sosNorm[i] * weights.sos +
                                                keenerNorm[i] * weights.keener +
                                                btNorm[i] * weights.bt
                                            ) * 100;
                                            
                                            return {
                                                team: team.team,
                                                score: score.toFixed(1),
                                                components: {
                                                    elo: (eloNorm[i] * 100).toFixed(0),
                                                    pi: (piNorm[i] * 100).toFixed(0),
                                                    massey: (masseyNorm[i] * 100).toFixed(0),
                                                    colley: (colleyNorm[i] * 100).toFixed(0),
                                                    spi: (spiNorm[i] * 100).toFixed(0),
                                                    sos: (sosNorm[i] * 100).toFixed(0),
                                                    keener: (keenerNorm[i] * 100).toFixed(0),
                                                    bt: (btNorm[i] * 100).toFixed(0)
                                                }
                                            };
                                        }).sort((a, b) => parseFloat(b.score) - parseFloat(a.score));
                                        
                                        const maxScore = parseFloat(ensembleScores[0]?.score) || 100;
                                        
                                        return (
                                            <div className="space-y-4">
                                                {ensembleScores.map((team, idx) => (
                                                    <div key={team.team} className="bg-white/5 rounded-xl p-4">
                                                        <div className="flex items-center gap-4 mb-3">
                                                            <span className={`w-10 h-10 rounded-xl flex items-center justify-center font-bold ${
                                                                idx === 0 ? 'bg-gradient-to-br from-amber-400 to-amber-600 text-slate-900' : 
                                                                idx === 1 ? 'bg-gradient-to-br from-slate-300 to-slate-400 text-slate-900' : 
                                                                idx === 2 ? 'bg-gradient-to-br from-orange-400 to-orange-600 text-white' : 
                                                                'bg-white/10 text-white'
                                                            }`}>{idx + 1}</span>
                                                            <div className="flex-1">
                                                                <div className="flex items-center justify-between mb-1">
                                                                    <span className="font-bold">{team.team}</span>
                                                                    <span className="text-2xl font-bold text-emerald-400">{team.score}</span>
                                                                </div>
                                                                <div className="h-3 bg-white/10 rounded-full overflow-hidden">
                                                                    <div 
                                                                        className={`h-full rounded-full ${
                                                                            idx === 0 ? 'bg-gradient-to-r from-amber-400 to-amber-500' :
                                                                            idx === 1 ? 'bg-gradient-to-r from-slate-300 to-slate-400' :
                                                                            idx === 2 ? 'bg-gradient-to-r from-orange-400 to-orange-500' :
                                                                            'bg-gradient-to-r from-emerald-500 to-emerald-400'
                                                                        }`}
                                                                        style={{ width: `${(parseFloat(team.score) / maxScore) * 100}%` }}
                                                                    />
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="grid grid-cols-4 md:grid-cols-8 gap-2 text-xs">
                                                            <div className="text-center"><span className="text-amber-400 font-medium">ELO</span><br/><span className="text-slate-300">{team.components.elo}</span></div>
                                                            <div className="text-center"><span className="text-emerald-400 font-medium">Pi</span><br/><span className="text-slate-300">{team.components.pi}</span></div>
                                                            <div className="text-center"><span className="text-blue-400 font-medium">Mas</span><br/><span className="text-slate-300">{team.components.massey}</span></div>
                                                            <div className="text-center"><span className="text-purple-400 font-medium">Col</span><br/><span className="text-slate-300">{team.components.colley}</span></div>
                                                            <div className="text-center"><span className="text-pink-400 font-medium">SPI</span><br/><span className="text-slate-300">{team.components.spi}</span></div>
                                                            <div className="text-center"><span className="text-cyan-400 font-medium">SOS</span><br/><span className="text-slate-300">{team.components.sos}</span></div>
                                                            <div className="text-center"><span className="text-orange-400 font-medium">Keen</span><br/><span className="text-slate-300">{team.components.keener}</span></div>
                                                            <div className="text-center"><span className="text-red-400 font-medium">B-T</span><br/><span className="text-slate-300">{team.components.bt}</span></div>
                                                        </div>
                                                    </div>
                                                ))}
                                                
                                                {/* Weights Legend */}
                                                <div className="mt-4 pt-4 border-t border-white/10">
                                                    <p className="text-xs text-slate-500 mb-2">Pesi: ELO 15% â€¢ Pi 10% â€¢ Massey 15% â€¢ Colley 15% â€¢ SPI 10% â€¢ SOS 10% â€¢ Keener 10% â€¢ B-T 15%</p>
                                                    <p className="text-xs text-slate-500">Ogni punteggio componente Ã¨ normalizzato (0-100). Il punteggio finale Ã¨ la media pesata.</p>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                        )}

                        {activeTab === 'points' && (
                            <div className="space-y-6">
                                <h2 className="text-xl font-bold">Statistiche Punti Fantacalcio</h2>
                                {pointsStats.length > 0 ? (
                                    <>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                            <div className="glass rounded-2xl p-5">
                                                <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-emerald-500/20 rounded-xl flex items-center justify-center text-emerald-400"><Icons.TrendingUp /></div><div><p className="text-slate-400 text-sm">Miglior Attacco</p><p className="font-bold">Media Punti Fatti</p></div></div>
                                                <div className="space-y-2">{[...pointsStats].sort((a,b) => parseFloat(b.avgFor) - parseFloat(a.avgFor)).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-emerald-400">{team.avgFor}</span></div>)}</div>
                                            </div>
                                            <div className="glass rounded-2xl p-5">
                                                <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center text-blue-400"><Icons.Shield /></div><div><p className="text-slate-400 text-sm">Miglior Difesa</p><p className="font-bold">Media Punti Subiti</p></div></div>
                                                <div className="space-y-2">{[...pointsStats].sort((a,b) => parseFloat(a.avgAgainst) - parseFloat(b.avgAgainst)).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-blue-400">{team.avgAgainst}</span></div>)}</div>
                                            </div>
                                            <div className="glass rounded-2xl p-5">
                                                <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-amber-500/20 rounded-xl flex items-center justify-center text-amber-400"><Icons.Zap /></div><div><p className="text-slate-400 text-sm">Prestazione Massima</p><p className="font-bold">Punteggio PiÃ¹ Alto</p></div></div>
                                                <div className="space-y-2">{[...pointsStats].sort((a,b) => b.highestScore - a.highestScore).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-amber-400">{team.highestScore.toFixed(1)}</span></div>)}</div>
                                            </div>
                                            <div className="glass rounded-2xl p-5">
                                                <div className="flex items-center gap-3 mb-4"><div className="w-10 h-10 bg-purple-500/20 rounded-xl flex items-center justify-center text-purple-400"><Icons.Activity /></div><div><p className="text-slate-400 text-sm">PiÃ¹ Consistente</p><p className="font-bold">Dev. Standard Bassa</p></div></div>
                                                <div className="space-y-2">{[...pointsStats].sort((a,b) => parseFloat(a.consistency) - parseFloat(b.consistency)).slice(0, 3).map((team) => <div key={team.team} className="flex items-center justify-between"><span className="text-sm truncate max-w-[140px]">{team.team}</span><span className="font-bold text-purple-400">Ïƒ {team.consistency}</span></div>)}</div>
                                            </div>
                                        </div>

                                        {/* Medie di Lega Window */}
                                        <div className="glass rounded-2xl p-6">
                                            <h3 className="font-bold mb-4 flex items-center gap-2"><Icons.BarChart /> Medie di Lega</h3>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                {/* Media Punti per Partita */}
                                                <div className="bg-white/5 rounded-xl p-5">
                                                    <h4 className="text-lg font-semibold text-emerald-400 mb-3">Media Punti per Partita</h4>
                                                    <p className="text-slate-400 text-sm mb-4">Media punti totali segnati per partita (entrambe le squadre)</p>
                                                    <div className="flex items-end gap-2">
                                                        <span className="text-4xl font-bold text-white">
                                                            {(() => {
                                                                const playedMatches = pointsMatches.filter(m => m.HGoals !== '' && m.AGoals !== '');
                                                                if (playedMatches.length === 0) return '0.0';
                                                                const totalCombined = playedMatches.reduce((sum, m) => sum + parseFloat(m.HGoals) + parseFloat(m.AGoals), 0);
                                                                return (totalCombined / playedMatches.length).toFixed(1);
                                                            })()}
                                                        </span>
                                                        <span className="text-slate-400 mb-1">pts/partita</span>
                                                    </div>
                                                    <div className="mt-4 pt-4 border-t border-white/10">
                                                        <div className="flex justify-between text-sm mb-2">
                                                            <span className="text-slate-400">Punti Combinati Totali</span>
                                                            <span className="font-medium">{pointsMatches.filter(m => m.HGoals !== '').reduce((sum, m) => sum + parseFloat(m.HGoals || 0) + parseFloat(m.AGoals || 0), 0).toFixed(1)}</span>
                                                        </div>
                                                        <div className="flex justify-between text-sm">
                                                            <span className="text-slate-400">Partite Giocate Totali</span>
                                                            <span className="font-medium">{pointsMatches.filter(m => m.HGoals !== '').length}</span>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* Media Punti per Giornata */}
                                                <div className="bg-white/5 rounded-xl p-5">
                                                    <h4 className="text-lg font-semibold text-blue-400 mb-3">Media Punti per Giornata</h4>
                                                    <p className="text-slate-400 text-sm mb-4">Media punti totali per giornata (tutte le partite)</p>
                                                    <div className="flex items-end gap-2">
                                                        <span className="text-4xl font-bold text-white">
                                                            {(() => {
                                                                const playedMatches = pointsMatches.filter(m => m.HGoals !== '' && m.AGoals !== '');
                                                                const playedRounds = [...new Set(playedMatches.map(m => m.Date))];
                                                                if (playedRounds.length === 0) return '0.0';
                                                                const totalCombined = playedMatches.reduce((sum, m) => sum + parseFloat(m.HGoals) + parseFloat(m.AGoals), 0);
                                                                return (totalCombined / playedRounds.length).toFixed(1);
                                                            })()}
                                                        </span>
                                                        <span className="text-slate-400 mb-1">pts/giornata</span>
                                                    </div>
                                                    <div className="mt-4 pt-4 border-t border-white/10">
                                                        <div className="flex justify-between text-sm mb-2">
                                                            <span className="text-slate-400">Giornate Giocate</span>
                                                            <span className="font-medium">{[...new Set(pointsMatches.filter(m => m.HGoals !== '').map(m => m.Date))].length}</span>
                                                        </div>
                                                        <div className="flex justify-between text-sm">
                                                            <span className="text-slate-400">Partite per Giornata</span>
                                                            <span className="font-medium">{pointsStats.length > 0 ? pointsStats.length / 2 : 0}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Punteggi PiÃ¹ Frequenti Window */}
                                        <div className="glass rounded-2xl p-6">
                                            <h3 className="font-bold mb-4 flex items-center gap-2"><Icons.Activity /> Punteggi PiÃ¹ Frequenti</h3>
                                            <p className="text-slate-400 text-sm mb-4">I 5 punteggi piÃ¹ comuni realizzati dalle squadre</p>
                                            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                                                {(() => {
                                                    const playedMatches = pointsMatches.filter(m => m.HGoals !== '' && m.AGoals !== '');
                                                    const allScores = playedMatches.flatMap(m => [parseFloat(m.HGoals), parseFloat(m.AGoals)]);
                                                    
                                                    // Count frequency of each score (rounded to nearest 0.5)
                                                    const frequency = {};
                                                    allScores.forEach(score => {
                                                        const rounded = Math.round(score * 2) / 2; // Round to nearest 0.5
                                                        frequency[rounded] = (frequency[rounded] || 0) + 1;
                                                    });
                                                    
                                                    // Sort by frequency and get top 5
                                                    const top5 = Object.entries(frequency)
                                                        .sort((a, b) => b[1] - a[1])
                                                        .slice(0, 5);
                                                    
                                                    const maxCount = top5.length > 0 ? top5[0][1] : 1;
                                                    
                                                    return top5.map(([score, count], index) => (
                                                        <div key={score} className="bg-white/5 rounded-xl p-4 text-center">
                                                            <div className={`text-3xl font-bold mb-2 ${index === 0 ? 'text-amber-400' : index === 1 ? 'text-slate-300' : index === 2 ? 'text-orange-400' : 'text-white'}`}>
                                                                {parseFloat(score).toFixed(1)}
                                                            </div>
                                                            <div className="text-sm text-slate-400 mb-2">points</div>
                                                            <div className="h-2 bg-white/10 rounded-full overflow-hidden mb-2">
                                                                <div 
                                                                    className={`h-full rounded-full ${index === 0 ? 'bg-amber-400' : index === 1 ? 'bg-slate-300' : index === 2 ? 'bg-orange-400' : 'bg-emerald-400'}`}
                                                                    style={{ width: `${(count / maxCount) * 100}%` }}
                                                                />
                                                            </div>
                                                            <div className="text-sm font-medium">{count} volte</div>
                                                        </div>
                                                    ));
                                                })()}
                                            </div>
                                        </div>

                                        <div className="glass rounded-2xl overflow-hidden">
                                            <div className="px-6 py-4 bg-white/5 border-b border-white/10"><h3 className="font-bold">Statistiche Punti Complete</h3><p className="text-sm text-slate-400">Clicca sulle intestazioni per ordinare</p></div>
                                            <div className="overflow-x-auto scrollbar-thin">
                                                <table className="w-full">
                                                    <thead><tr className="text-sm text-slate-400 border-b border-white/10">
                                                        <th className="px-6 py-3 text-left cursor-pointer hover:text-white transition-colors" onClick={() => handlePointsSort('team')}>Squadra<SortIcon column="team" current={pointsSort} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handlePointsSort('played')}>P<SortIcon column="played" current={pointsSort} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handlePointsSort('totalFor')}>PF Tot<SortIcon column="totalFor" current={pointsSort} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handlePointsSort('totalAgainst')}>PS Tot<SortIcon column="totalAgainst" current={pointsSort} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handlePointsSort('avgFor')}>Media PF<SortIcon column="avgFor" current={pointsSort} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handlePointsSort('avgAgainst')}>Media PS<SortIcon column="avgAgainst" current={pointsSort} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handlePointsSort('pointsDiff')}>Diff<SortIcon column="pointsDiff" current={pointsSort} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handlePointsSort('highestScore')}>Max<SortIcon column="highestScore" current={pointsSort} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handlePointsSort('lowestScore')}>Min<SortIcon column="lowestScore" current={pointsSort} /></th>
                                                        <th className="px-4 py-3 text-center cursor-pointer hover:text-white transition-colors" onClick={() => handlePointsSort('consistency')}>Ïƒ<SortIcon column="consistency" current={pointsSort} /></th>
                                                    </tr></thead>
                                                    <tbody>{[...pointsStats].sort((a, b) => {
                                                        const aVal = pointsSort.column === 'team' ? a.team : parseFloat(a[pointsSort.column]) || 0;
                                                        const bVal = pointsSort.column === 'team' ? b.team : parseFloat(b[pointsSort.column]) || 0;
                                                        if (pointsSort.column === 'team') {
                                                            return pointsSort.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                                                        }
                                                        return pointsSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                                                    }).map((team) => (
                                                        <tr key={team.team} className="border-b border-white/5 hover:bg-white/5">
                                                            <td className="px-6 py-4 font-medium">{team.team}</td>
                                                            <td className="px-4 py-4 text-center text-slate-300">{team.played}</td>
                                                            <td className="px-4 py-4 text-center text-emerald-400">{team.totalFor.toFixed(1)}</td>
                                                            <td className="px-4 py-4 text-center text-red-400">{team.totalAgainst.toFixed(1)}</td>
                                                            <td className="px-4 py-4 text-center text-emerald-400 font-bold">{team.avgFor}</td>
                                                            <td className="px-4 py-4 text-center text-red-400 font-bold">{team.avgAgainst}</td>
                                                            <td className="px-4 py-4 text-center"><span className={`font-bold ${parseFloat(team.pointsDiff) > 0 ? 'text-emerald-400' : 'text-red-400'}`}>{parseFloat(team.pointsDiff) > 0 ? '+' : ''}{team.pointsDiff}</span></td>
                                                            <td className="px-4 py-4 text-center text-amber-400">{team.highestScore.toFixed(1)}</td>
                                                            <td className="px-4 py-4 text-center text-slate-400">{team.lowestScore === Infinity ? '-' : team.lowestScore.toFixed(1)}</td>
                                                            <td className="px-4 py-4 text-center text-purple-400">{team.consistency}</td>
                                                        </tr>
                                                    ))}</tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div className="glass rounded-2xl p-6">
                                            <h3 className="font-bold mb-4">Season Total Points</h3>
                                            <div className="space-y-3">
                                                {[...pointsStats].sort((a,b) => b.totalFor - a.totalFor).map((team) => {
                                                    const maxTotal = Math.max(...pointsStats.map(t => t.totalFor));
                                                    const percentage = (team.totalFor / maxTotal) * 100;
                                                    return (
                                                        <div key={team.team} className="space-y-1">
                                                            <div className="flex justify-between text-sm"><span className="font-medium">{team.team}</span><span className="text-emerald-400 font-bold">{team.totalFor.toFixed(1)}</span></div>
                                                            <div className="h-2 bg-white/10 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full" style={{ width: `${percentage}%` }} /></div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <div className="glass rounded-2xl p-12 text-center">
                                        <h3 className="text-lg font-bold mt-4 mb-2">No Points Data Available</h3>
                                        <p className="text-slate-400">Upload a Points CSV file using the blue button in the header.</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'calendar' && (
                            <div className="space-y-6">
                                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                    <h2 className="text-xl font-bold">Match Calendar</h2>
                                    <div className="flex items-center gap-2 overflow-x-auto pb-2 scrollbar-thin">
                                        {matchdays.map(day => {
                                            const isPlayed = matches.filter(m => parseInt(m.Date) === day).some(m => m.HGoals !== '');
                                            return (
                                                <button key={day} onClick={() => setSelectedGiornata(day)}
                                                    className={`px-4 py-2 rounded-xl font-medium transition-all whitespace-nowrap ${(selectedGiornata || currentGiornata) === day ? 'bg-gradient-to-r from-emerald-500 to-emerald-600 text-white shadow-lg' : isPlayed ? 'bg-white/10 text-white hover:bg-white/20' : 'bg-white/5 text-slate-400 hover:bg-white/10'}`}>
                                                    {day}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div className="glass rounded-2xl p-6">
                                    <h3 className="text-lg font-bold mb-6">Giornata {selectedGiornata || currentGiornata}{matchdayMatches[0]?.HGoals === '' && <span className="ml-3 text-sm font-normal text-slate-400">â€¢ Not yet played</span>}</h3>
                                    <div className="grid gap-4">
                                        {matchdayMatches.map((match, index) => {
                                            const isPlayed = match.HGoals !== '' && match.AGoals !== '';
                                            const pointsMatch = matchdayPointsMatches.find(pm => pm.HomeTeam === match.HomeTeam && pm.AwayTeam === match.AwayTeam);
                                            return (
                                                <div key={index} className={`rounded-xl p-4 ${isPlayed ? 'bg-white/5' : 'bg-white/[0.02] border border-dashed border-white/10'}`}>
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex-1"><p className={`font-semibold text-right ${match.Result === 'H' ? 'text-emerald-400' : ''}`}>{match.HomeTeam}</p></div>
                                                        <div className="px-6 flex items-center gap-3">
                                                            {isPlayed ? (<><span className={`text-3xl font-bold ${match.Result === 'H' ? 'text-emerald-400' : 'text-white'}`}>{match.HGoals}</span><span className="text-slate-500 text-xl">-</span><span className={`text-3xl font-bold ${match.Result === 'A' ? 'text-emerald-400' : 'text-white'}`}>{match.AGoals}</span></>) : (<span className="text-slate-500 font-medium">vs</span>)}
                                                        </div>
                                                        <div className="flex-1"><p className={`font-semibold text-left ${match.Result === 'A' ? 'text-emerald-400' : ''}`}>{match.AwayTeam}</p></div>
                                                    </div>
                                                    {pointsMatch && pointsMatch.HGoals !== '' && (
                                                        <div className="flex items-center justify-center mt-2 pt-2 border-t border-white/10">
                                                            <span className="text-sm text-slate-400">Punti: </span>
                                                            <span className="text-sm text-blue-400 ml-2 font-medium">{pointsMatch.HGoals}</span>
                                                            <span className="text-slate-500 mx-2">-</span>
                                                            <span className="text-sm text-blue-400 font-medium">{pointsMatch.AGoals}</span>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'simulator' && (
                            <div className="space-y-6">
                                <div>
                                    <h2 className="text-xl font-bold">âš½ Simulazione Partita</h2>
                                    <p className="text-slate-400 text-sm mt-1">Simula un ipotetico scontro tra due squadre usando il modello di Poisson</p>
                                </div>
                                
                                {/* Legend */}
                                <div className="glass rounded-xl p-4">
                                    <h3 className="text-sm font-semibold text-slate-300 mb-3">ðŸ“– Come Funziona il Modello</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-400">
                                        <div><span className="text-white font-medium">Modello:</span> Poisson GLM â†’ Goals ~ Team + Opponent (come in R)</div>
                                        <div><span className="text-white font-medium">Î» (xGol):</span> = Î¼ Ã— Attack<sub>team</sub> Ã— Defense<sub>opponent</sub></div>
                                        <div><span className="text-white font-medium">Attack:</span> Gol segnati / Media lega ({">"} 1 = sopra media)</div>
                                        <div><span className="text-white font-medium">Defense:</span> Gol subiti / Media lega ({"<"} 1 = difesa forte)</div>
                                        <div><span className="text-white font-medium">Conversione Puntiâ†’Gol:</span> {"<"}66 = 0, 66-69.5 = 1, 70-73.5 = 2, 74-77.5 = 3...</div>
                                        <div><span className="text-white font-medium">Quote:</span> Calcolate dalla distribuzione di Poisson (P(X=k) = Î»<sup>k</sup>e<sup>-Î»</sup>/k!)</div>
                                    </div>
                                </div>
                                
                                {/* Team Selection */}
                                <div className="glass rounded-2xl p-6">
                                    <h3 className="font-bold mb-4">Seleziona le Squadre</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                                        <div>
                                            <label className="block text-sm text-slate-400 mb-2">Squadra Casa ðŸ </label>
                                            <select 
                                                value={simHomeTeam} 
                                                onChange={(e) => setSimHomeTeam(e.target.value)}
                                                className="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-emerald-500"
                                            >
                                                <option value="" className="bg-slate-800">-- Seleziona --</option>
                                                {standings.map(team => (
                                                    <option key={team.team} value={team.team} className="bg-slate-800">{team.team}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="text-center text-3xl font-bold text-slate-500">VS</div>
                                        <div>
                                            <label className="block text-sm text-slate-400 mb-2">Squadra Trasferta âœˆï¸</label>
                                            <select 
                                                value={simAwayTeam} 
                                                onChange={(e) => setSimAwayTeam(e.target.value)}
                                                className="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500"
                                            >
                                                <option value="" className="bg-slate-800">-- Seleziona --</option>
                                                {standings.filter(t => t.team !== simHomeTeam).map(team => (
                                                    <option key={team.team} value={team.team} className="bg-slate-800">{team.team}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Simulation Results */}
                                {simHomeTeam && simAwayTeam && (() => {
                                    // Get team stats from points matches
                                    const playedPointsMatches = pointsMatches.filter(m => m.HGoals !== '' && m.AGoals !== '');
                                    
                                    if (playedPointsMatches.length === 0) {
                                        return <div className="glass rounded-2xl p-6 text-center text-slate-400">Carica i dati dei punti per usare il simulatore</div>;
                                    }
                                    
                                    // Convert points to goals: <66 = 0, 66-69.5 = 1, 70-73.5 = 2, 74-77.5 = 3, etc.
                                    const pointsToGoals = (points) => {
                                        if (points < 66) return 0;
                                        return Math.floor((points - 66) / 4) + 1;
                                    };
                                    
                                    // Build long-format data for Poisson regression: Goals ~ Team + Opponent
                                    // Each match contributes 2 rows: one for home team scoring, one for away team scoring
                                    const longData = [];
                                    playedPointsMatches.forEach(m => {
                                        const homeGoals = pointsToGoals(parseFloat(m.HGoals));
                                        const awayGoals = pointsToGoals(parseFloat(m.AGoals));
                                        // Home team scoring against away team
                                        longData.push({ goals: homeGoals, team: m.HomeTeam, opponent: m.AwayTeam, points: parseFloat(m.HGoals) });
                                        // Away team scoring against home team  
                                        longData.push({ goals: awayGoals, team: m.AwayTeam, opponent: m.HomeTeam, points: parseFloat(m.AGoals) });
                                    });
                                    
                                    // Get unique teams
                                    const teams = [...new Set(longData.map(d => d.team))];
                                    const nTeams = teams.length;
                                    
                                    // Poisson GLM with log link: log(Î») = intercept + attack[team] + defense[opponent]
                                    // Using iteratively reweighted least squares (IRLS) approximation
                                    // Simplified: estimate attack and defense strengths from averages
                                    
                                    // Calculate league average goals per game
                                    const leagueAvgGoals = longData.reduce((sum, d) => sum + d.goals, 0) / longData.length;
                                    const leagueAvgPoints = longData.reduce((sum, d) => sum + d.points, 0) / longData.length;
                                    
                                    // Calculate attack strength (goals scored / league avg) and defense strength (goals conceded / league avg)
                                    const teamParams = {};
                                    teams.forEach(team => {
                                        const attacking = longData.filter(d => d.team === team);
                                        const defending = longData.filter(d => d.opponent === team);
                                        
                                        const goalsScored = attacking.reduce((sum, d) => sum + d.goals, 0);
                                        const goalsConceded = defending.reduce((sum, d) => sum + d.goals, 0);
                                        const pointsScored = attacking.reduce((sum, d) => sum + d.points, 0);
                                        const pointsConceded = defending.reduce((sum, d) => sum + d.points, 0);
                                        
                                        // Attack = goals scored relative to league average
                                        // Defense = goals conceded relative to league average (lower is better)
                                        teamParams[team] = {
                                            attack: attacking.length > 0 ? (goalsScored / attacking.length) / leagueAvgGoals : 1,
                                            defense: defending.length > 0 ? (goalsConceded / defending.length) / leagueAvgGoals : 1,
                                            avgPointsScored: attacking.length > 0 ? pointsScored / attacking.length : leagueAvgPoints,
                                            avgPointsConceded: defending.length > 0 ? pointsConceded / defending.length : leagueAvgPoints,
                                            gamesAttacking: attacking.length,
                                            gamesDefending: defending.length
                                        };
                                    });
                                    
                                    // Poisson GLM prediction: Î» = leagueAvg * attackStrength[team] * defenseStrength[opponent]
                                    // This is equivalent to: log(Î») = log(leagueAvg) + log(attack) + log(defense)
                                    const homeParams = teamParams[simHomeTeam];
                                    const awayParams = teamParams[simAwayTeam];
                                    
                                    // Expected goals (lambda for Poisson)
                                    const xGHome = leagueAvgGoals * homeParams.attack * awayParams.defense;
                                    const xGAway = leagueAvgGoals * awayParams.attack * homeParams.defense;
                                    
                                    // Expected points (using same model structure)
                                    const xPointsHome = leagueAvgPoints * (homeParams.avgPointsScored / leagueAvgPoints) * (awayParams.avgPointsConceded / leagueAvgPoints);
                                    const xPointsAway = leagueAvgPoints * (awayParams.avgPointsScored / leagueAvgPoints) * (homeParams.avgPointsConceded / leagueAvgPoints);
                                    
                                    // Poisson probability function
                                    const poisson = (lambda, k) => {
                                        if (lambda <= 0) return k === 0 ? 1 : 0;
                                        return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
                                    };
                                    
                                    const factorial = (n) => {
                                        if (n <= 1) return 1;
                                        let result = 1;
                                        for (let i = 2; i <= n; i++) result *= i;
                                        return result;
                                    };
                                    
                                    // Calculate match outcome probabilities
                                    let homeWinProb = 0, drawProb = 0, awayWinProb = 0;
                                    const maxGoals = 10;
                                    const scoreMatrix = [];
                                    
                                    for (let hg = 0; hg <= maxGoals; hg++) {
                                        scoreMatrix[hg] = [];
                                        for (let ag = 0; ag <= maxGoals; ag++) {
                                            const prob = poisson(xGHome, hg) * poisson(xGAway, ag);
                                            scoreMatrix[hg][ag] = prob;
                                            if (hg > ag) homeWinProb += prob;
                                            else if (hg < ag) awayWinProb += prob;
                                            else drawProb += prob;
                                        }
                                    }
                                    
                                    // Over/Under calculations for total points
                                    const totalXPoints = xPointsHome + xPointsAway;
                                    const overUnderLines = [130, 135, 140, 145, 150];
                                    
                                    // Calculate over/under probabilities using normal distribution approximation
                                    const stdDev = 8; // Approximate standard deviation for combined points
                                    const normalCDF = (x, mean, std) => {
                                        return 0.5 * (1 + erf((x - mean) / (std * Math.sqrt(2))));
                                    };
                                    const erf = (x) => {
                                        const a1 =  0.254829592, a2 = -0.284496736, a3 = 1.421413741;
                                        const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
                                        const sign = x < 0 ? -1 : 1;
                                        x = Math.abs(x);
                                        const t = 1.0 / (1.0 + p * x);
                                        const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
                                        return sign * y;
                                    };
                                    
                                    // Most likely scorelines
                                    const likelyScores = [];
                                    for (let hg = 0; hg <= 6; hg++) {
                                        for (let ag = 0; ag <= 6; ag++) {
                                            likelyScores.push({ home: hg, away: ag, prob: scoreMatrix[hg][ag] });
                                        }
                                    }
                                    likelyScores.sort((a, b) => b.prob - a.prob);
                                    
                                    // Convert probability to decimal odds
                                    const probToOdds = (prob) => prob > 0 ? (1 / prob).toFixed(2) : 'âˆž';
                                    
                                    return (
                                        <>
                                            {/* Model Info */}
                                            <div className="glass rounded-xl p-4 bg-blue-500/5 border border-blue-500/20">
                                                <h3 className="text-sm font-semibold text-blue-400 mb-2">ðŸ“Š Modello Poisson GLM</h3>
                                                <p className="text-xs text-slate-400">
                                                    <code>log(Î») = log(Î¼) + log(Attack<sub>team</sub>) + log(Defense<sub>opponent</sub>)</code>
                                                    <br/>Media lega: <span className="text-white">{leagueAvgGoals.toFixed(2)} gol</span> | <span className="text-white">{leagueAvgPoints.toFixed(1)} punti</span> per partita
                                                </p>
                                            </div>
                                            
                                            {/* Expected Points & Goals */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div className="glass rounded-2xl p-6">
                                                    <div className="flex items-center gap-3 mb-4">
                                                        <div className="w-12 h-12 bg-emerald-500/20 rounded-xl flex items-center justify-center text-2xl">ðŸ </div>
                                                        <div>
                                                            <p className="text-slate-400 text-sm">Squadra A</p>
                                                            <p className="font-bold text-lg">{simHomeTeam}</p>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div className="bg-white/5 rounded-xl p-4 text-center">
                                                            <p className="text-slate-400 text-xs mb-1">xPunti</p>
                                                            <p className="text-3xl font-bold text-emerald-400">{xPointsHome.toFixed(1)}</p>
                                                        </div>
                                                        <div className="bg-white/5 rounded-xl p-4 text-center">
                                                            <p className="text-slate-400 text-xs mb-1">Î» (xGol)</p>
                                                            <p className="text-3xl font-bold text-emerald-400">{xGHome.toFixed(2)}</p>
                                                        </div>
                                                    </div>
                                                    <div className="mt-4 text-sm text-slate-400 space-y-1">
                                                        <div className="flex justify-between"><span>Attack Strength:</span><span className={`font-medium ${homeParams.attack >= 1 ? 'text-emerald-400' : 'text-red-400'}`}>{homeParams.attack.toFixed(3)}</span></div>
                                                        <div className="flex justify-between"><span>Defense Strength:</span><span className={`font-medium ${homeParams.defense <= 1 ? 'text-emerald-400' : 'text-red-400'}`}>{homeParams.defense.toFixed(3)}</span></div>
                                                        <div className="flex justify-between"><span>Media Punti:</span><span className="text-white">{homeParams.avgPointsScored.toFixed(1)}</span></div>
                                                        <div className="flex justify-between"><span>Partite giocate:</span><span className="text-white">{homeParams.gamesAttacking}</span></div>
                                                    </div>
                                                </div>
                                                
                                                <div className="glass rounded-2xl p-6">
                                                    <div className="flex items-center gap-3 mb-4">
                                                        <div className="w-12 h-12 bg-blue-500/20 rounded-xl flex items-center justify-center text-2xl">âœˆï¸</div>
                                                        <div>
                                                            <p className="text-slate-400 text-sm">Squadra B</p>
                                                            <p className="font-bold text-lg">{simAwayTeam}</p>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div className="bg-white/5 rounded-xl p-4 text-center">
                                                            <p className="text-slate-400 text-xs mb-1">xPunti</p>
                                                            <p className="text-3xl font-bold text-blue-400">{xPointsAway.toFixed(1)}</p>
                                                        </div>
                                                        <div className="bg-white/5 rounded-xl p-4 text-center">
                                                            <p className="text-slate-400 text-xs mb-1">Î» (xGol)</p>
                                                            <p className="text-3xl font-bold text-blue-400">{xGAway.toFixed(2)}</p>
                                                        </div>
                                                    </div>
                                                    <div className="mt-4 text-sm text-slate-400 space-y-1">
                                                        <div className="flex justify-between"><span>Attack Strength:</span><span className={`font-medium ${awayParams.attack >= 1 ? 'text-blue-400' : 'text-red-400'}`}>{awayParams.attack.toFixed(3)}</span></div>
                                                        <div className="flex justify-between"><span>Defense Strength:</span><span className={`font-medium ${awayParams.defense <= 1 ? 'text-blue-400' : 'text-red-400'}`}>{awayParams.defense.toFixed(3)}</span></div>
                                                        <div className="flex justify-between"><span>Media Punti:</span><span className="text-white">{awayParams.avgPointsScored.toFixed(1)}</span></div>
                                                        <div className="flex justify-between"><span>Partite giocate:</span><span className="text-white">{awayParams.gamesAttacking}</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Poisson Distribution Graphs */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                {/* Home Team Distribution */}
                                                <div className="glass rounded-2xl p-6">
                                                    <h3 className="font-bold mb-4 text-emerald-400">ðŸ“Š Distribuzione Gol - {simHomeTeam}</h3>
                                                    <p className="text-xs text-slate-400 mb-4">ProbabilitÃ  di segnare X gol (Î» = {xGHome.toFixed(2)})</p>
                                                    <div className="space-y-2">
                                                        {[0,1,2,3,4,5,6].map(goals => {
                                                            const prob = poisson(xGHome, goals) * 100;
                                                            const pointsRange = goals === 0 ? '<66' : `${66 + (goals-1)*4}-${66 + goals*4 - 0.5}`;
                                                            return (
                                                                <div key={goals} className="flex items-center gap-3">
                                                                    <div className="w-8 text-center font-bold text-lg">{goals}</div>
                                                                    <div className="flex-1 h-8 bg-white/5 rounded-lg overflow-hidden relative">
                                                                        <div 
                                                                            className="h-full bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-lg transition-all duration-500"
                                                                            style={{ width: `${Math.min(prob * 2, 100)}%` }}
                                                                        />
                                                                        <span className="absolute inset-0 flex items-center justify-center text-sm font-medium">
                                                                            {prob.toFixed(1)}%
                                                                        </span>
                                                                    </div>
                                                                    <div className="w-20 text-xs text-slate-500 text-right">{pointsRange} pts</div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                    <div className="mt-4 pt-4 border-t border-white/10 grid grid-cols-3 gap-2 text-center text-xs">
                                                        <div>
                                                            <p className="text-slate-400">P(0-1 gol)</p>
                                                            <p className="font-bold text-emerald-400">{((poisson(xGHome,0) + poisson(xGHome,1)) * 100).toFixed(1)}%</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-slate-400">P(2-3 gol)</p>
                                                            <p className="font-bold text-emerald-400">{((poisson(xGHome,2) + poisson(xGHome,3)) * 100).toFixed(1)}%</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-slate-400">P(4+ gol)</p>
                                                            <p className="font-bold text-emerald-400">{((1 - poisson(xGHome,0) - poisson(xGHome,1) - poisson(xGHome,2) - poisson(xGHome,3)) * 100).toFixed(1)}%</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                {/* Away Team Distribution */}
                                                <div className="glass rounded-2xl p-6">
                                                    <h3 className="font-bold mb-4 text-blue-400">ðŸ“Š Distribuzione Gol - {simAwayTeam}</h3>
                                                    <p className="text-xs text-slate-400 mb-4">ProbabilitÃ  di segnare X gol (Î» = {xGAway.toFixed(2)})</p>
                                                    <div className="space-y-2">
                                                        {[0,1,2,3,4,5,6].map(goals => {
                                                            const prob = poisson(xGAway, goals) * 100;
                                                            const pointsRange = goals === 0 ? '<66' : `${66 + (goals-1)*4}-${66 + goals*4 - 0.5}`;
                                                            return (
                                                                <div key={goals} className="flex items-center gap-3">
                                                                    <div className="w-8 text-center font-bold text-lg">{goals}</div>
                                                                    <div className="flex-1 h-8 bg-white/5 rounded-lg overflow-hidden relative">
                                                                        <div 
                                                                            className="h-full bg-gradient-to-r from-blue-500 to-blue-400 rounded-lg transition-all duration-500"
                                                                            style={{ width: `${Math.min(prob * 2, 100)}%` }}
                                                                        />
                                                                        <span className="absolute inset-0 flex items-center justify-center text-sm font-medium">
                                                                            {prob.toFixed(1)}%
                                                                        </span>
                                                                    </div>
                                                                    <div className="w-20 text-xs text-slate-500 text-right">{pointsRange} pts</div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                    <div className="mt-4 pt-4 border-t border-white/10 grid grid-cols-3 gap-2 text-center text-xs">
                                                        <div>
                                                            <p className="text-slate-400">P(0-1 gol)</p>
                                                            <p className="font-bold text-blue-400">{((poisson(xGAway,0) + poisson(xGAway,1)) * 100).toFixed(1)}%</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-slate-400">P(2-3 gol)</p>
                                                            <p className="font-bold text-blue-400">{((poisson(xGAway,2) + poisson(xGAway,3)) * 100).toFixed(1)}%</p>
                                                        </div>
                                                        <div>
                                                            <p className="text-slate-400">P(4+ gol)</p>
                                                            <p className="font-bold text-blue-400">{((1 - poisson(xGAway,0) - poisson(xGAway,1) - poisson(xGAway,2) - poisson(xGAway,3)) * 100).toFixed(1)}%</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Expected Points Bell Curve Distribution */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                {/* Home Team Points Distribution */}
                                                <div className="glass rounded-2xl p-6">
                                                    <h3 className="font-bold mb-2 text-emerald-400">ðŸ“ˆ Distribuzione Punti Attesi - {simHomeTeam}</h3>
                                                    <p className="text-xs text-slate-400 mb-4">Î¼ = {xPointsHome.toFixed(1)} pts | Ïƒ = {(() => {
                                                        const homePointsData = longData.filter(d => d.team === simHomeTeam).map(d => d.points);
                                                        if (homePointsData.length < 2) return 6;
                                                        const mean = homePointsData.reduce((a,b) => a+b, 0) / homePointsData.length;
                                                        const variance = homePointsData.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / homePointsData.length;
                                                        return Math.sqrt(variance).toFixed(1);
                                                    })()} pts</p>
                                                    
                                                    {/* SVG Bell Curve */}
                                                    <div className="relative">
                                                        <svg viewBox="0 0 400 180" className="w-full h-44">
                                                            {/* Grid lines */}
                                                            <defs>
                                                                <linearGradient id="bellGradientHome" x1="0%" y1="0%" x2="0%" y2="100%">
                                                                    <stop offset="0%" stopColor="rgb(16, 185, 129)" stopOpacity="0.6"/>
                                                                    <stop offset="100%" stopColor="rgb(16, 185, 129)" stopOpacity="0.1"/>
                                                                </linearGradient>
                                                            </defs>
                                                            
                                                            {/* X-axis */}
                                                            <line x1="40" y1="150" x2="380" y2="150" stroke="rgba(255,255,255,0.2)" strokeWidth="1"/>
                                                            
                                                            {/* Y-axis */}
                                                            <line x1="40" y1="20" x2="40" y2="150" stroke="rgba(255,255,255,0.2)" strokeWidth="1"/>
                                                            
                                                            {/* Bell curve path */}
                                                            {(() => {
                                                                const homePointsData = longData.filter(d => d.team === simHomeTeam).map(d => d.points);
                                                                const stdDev = homePointsData.length >= 2 
                                                                    ? Math.sqrt(homePointsData.reduce((sum, x) => sum + Math.pow(x - xPointsHome, 2), 0) / homePointsData.length)
                                                                    : 6;
                                                                const minPts = Math.max(50, xPointsHome - 4 * stdDev);
                                                                const maxPts = Math.min(100, xPointsHome + 4 * stdDev);
                                                                const range = maxPts - minPts;
                                                                
                                                                const normalPDF = (x, mean, std) => {
                                                                    return (1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mean) / std, 2));
                                                                };
                                                                
                                                                const maxPDF = normalPDF(xPointsHome, xPointsHome, stdDev);
                                                                const points = [];
                                                                const fillPoints = [];
                                                                
                                                                for (let i = 0; i <= 100; i++) {
                                                                    const pts = minPts + (range * i / 100);
                                                                    const pdf = normalPDF(pts, xPointsHome, stdDev);
                                                                    const x = 40 + (340 * i / 100);
                                                                    const y = 150 - (120 * pdf / maxPDF);
                                                                    points.push(`${x},${y}`);
                                                                    fillPoints.push(`${x},${y}`);
                                                                }
                                                                
                                                                const pathD = `M ${points.join(' L ')}`;
                                                                const fillD = `M 40,150 L ${fillPoints.join(' L ')} L 380,150 Z`;
                                                                
                                                                return (
                                                                    <>
                                                                        <path d={fillD} fill="url(#bellGradientHome)" />
                                                                        <path d={pathD} fill="none" stroke="rgb(16, 185, 129)" strokeWidth="2.5"/>
                                                                        
                                                                        {/* Mean line */}
                                                                        <line 
                                                                            x1={40 + 340 * (xPointsHome - minPts) / range} 
                                                                            y1="25" 
                                                                            x2={40 + 340 * (xPointsHome - minPts) / range} 
                                                                            y2="150" 
                                                                            stroke="rgb(16, 185, 129)" 
                                                                            strokeWidth="2" 
                                                                            strokeDasharray="5,5"
                                                                        />
                                                                        
                                                                        {/* X-axis labels */}
                                                                        <text x="40" y="168" fill="rgba(255,255,255,0.5)" fontSize="11" textAnchor="middle">{minPts.toFixed(0)}</text>
                                                                        <text x="210" y="168" fill="rgba(255,255,255,0.5)" fontSize="11" textAnchor="middle">{((minPts + maxPts) / 2).toFixed(0)}</text>
                                                                        <text x="380" y="168" fill="rgba(255,255,255,0.5)" fontSize="11" textAnchor="middle">{maxPts.toFixed(0)}</text>
                                                                        
                                                                        {/* Mean label */}
                                                                        <text 
                                                                            x={40 + 340 * (xPointsHome - minPts) / range} 
                                                                            y="18" 
                                                                            fill="rgb(16, 185, 129)" 
                                                                            fontSize="12" 
                                                                            fontWeight="bold"
                                                                            textAnchor="middle"
                                                                        >
                                                                            Î¼={xPointsHome.toFixed(1)}
                                                                        </text>
                                                                    </>
                                                                );
                                                            })()}
                                                        </svg>
                                                    </div>
                                                    
                                                    {/* Probability ranges */}
                                                    <div className="mt-2 grid grid-cols-3 gap-2 text-center text-xs">
                                                        {(() => {
                                                            const homePointsData = longData.filter(d => d.team === simHomeTeam).map(d => d.points);
                                                            const stdDev = homePointsData.length >= 2 
                                                                ? Math.sqrt(homePointsData.reduce((sum, x) => sum + Math.pow(x - xPointsHome, 2), 0) / homePointsData.length)
                                                                : 6;
                                                            return (
                                                                <>
                                                                    <div className="bg-white/5 rounded-lg p-2">
                                                                        <p className="text-slate-400">68% prob</p>
                                                                        <p className="font-bold text-emerald-400">{(xPointsHome - stdDev).toFixed(0)}-{(xPointsHome + stdDev).toFixed(0)}</p>
                                                                    </div>
                                                                    <div className="bg-white/5 rounded-lg p-2">
                                                                        <p className="text-slate-400">95% prob</p>
                                                                        <p className="font-bold text-emerald-400">{(xPointsHome - 2*stdDev).toFixed(0)}-{(xPointsHome + 2*stdDev).toFixed(0)}</p>
                                                                    </div>
                                                                    <div className="bg-white/5 rounded-lg p-2">
                                                                        <p className="text-slate-400">P({'>'}75 pts)</p>
                                                                        <p className="font-bold text-emerald-400">{((1 - normalCDF(75, xPointsHome, stdDev)) * 100).toFixed(0)}%</p>
                                                                    </div>
                                                                </>
                                                            );
                                                        })()}
                                                    </div>
                                                </div>
                                                
                                                {/* Away Team Points Distribution */}
                                                <div className="glass rounded-2xl p-6">
                                                    <h3 className="font-bold mb-2 text-blue-400">ðŸ“ˆ Distribuzione Punti Attesi - {simAwayTeam}</h3>
                                                    <p className="text-xs text-slate-400 mb-4">Î¼ = {xPointsAway.toFixed(1)} pts | Ïƒ = {(() => {
                                                        const awayPointsData = longData.filter(d => d.team === simAwayTeam).map(d => d.points);
                                                        if (awayPointsData.length < 2) return 6;
                                                        const mean = awayPointsData.reduce((a,b) => a+b, 0) / awayPointsData.length;
                                                        const variance = awayPointsData.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / awayPointsData.length;
                                                        return Math.sqrt(variance).toFixed(1);
                                                    })()} pts</p>
                                                    
                                                    {/* SVG Bell Curve */}
                                                    <div className="relative">
                                                        <svg viewBox="0 0 400 180" className="w-full h-44">
                                                            {/* Grid lines */}
                                                            <defs>
                                                                <linearGradient id="bellGradientAway" x1="0%" y1="0%" x2="0%" y2="100%">
                                                                    <stop offset="0%" stopColor="rgb(59, 130, 246)" stopOpacity="0.6"/>
                                                                    <stop offset="100%" stopColor="rgb(59, 130, 246)" stopOpacity="0.1"/>
                                                                </linearGradient>
                                                            </defs>
                                                            
                                                            {/* X-axis */}
                                                            <line x1="40" y1="150" x2="380" y2="150" stroke="rgba(255,255,255,0.2)" strokeWidth="1"/>
                                                            
                                                            {/* Y-axis */}
                                                            <line x1="40" y1="20" x2="40" y2="150" stroke="rgba(255,255,255,0.2)" strokeWidth="1"/>
                                                            
                                                            {/* Bell curve path */}
                                                            {(() => {
                                                                const awayPointsData = longData.filter(d => d.team === simAwayTeam).map(d => d.points);
                                                                const stdDev = awayPointsData.length >= 2 
                                                                    ? Math.sqrt(awayPointsData.reduce((sum, x) => sum + Math.pow(x - xPointsAway, 2), 0) / awayPointsData.length)
                                                                    : 6;
                                                                const minPts = Math.max(50, xPointsAway - 4 * stdDev);
                                                                const maxPts = Math.min(100, xPointsAway + 4 * stdDev);
                                                                const range = maxPts - minPts;
                                                                
                                                                const normalPDF = (x, mean, std) => {
                                                                    return (1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mean) / std, 2));
                                                                };
                                                                
                                                                const maxPDF = normalPDF(xPointsAway, xPointsAway, stdDev);
                                                                const points = [];
                                                                const fillPoints = [];
                                                                
                                                                for (let i = 0; i <= 100; i++) {
                                                                    const pts = minPts + (range * i / 100);
                                                                    const pdf = normalPDF(pts, xPointsAway, stdDev);
                                                                    const x = 40 + (340 * i / 100);
                                                                    const y = 150 - (120 * pdf / maxPDF);
                                                                    points.push(`${x},${y}`);
                                                                    fillPoints.push(`${x},${y}`);
                                                                }
                                                                
                                                                const pathD = `M ${points.join(' L ')}`;
                                                                const fillD = `M 40,150 L ${fillPoints.join(' L ')} L 380,150 Z`;
                                                                
                                                                return (
                                                                    <>
                                                                        <path d={fillD} fill="url(#bellGradientAway)" />
                                                                        <path d={pathD} fill="none" stroke="rgb(59, 130, 246)" strokeWidth="2.5"/>
                                                                        
                                                                        {/* Mean line */}
                                                                        <line 
                                                                            x1={40 + 340 * (xPointsAway - minPts) / range} 
                                                                            y1="25" 
                                                                            x2={40 + 340 * (xPointsAway - minPts) / range} 
                                                                            y2="150" 
                                                                            stroke="rgb(59, 130, 246)" 
                                                                            strokeWidth="2" 
                                                                            strokeDasharray="5,5"
                                                                        />
                                                                        
                                                                        {/* X-axis labels */}
                                                                        <text x="40" y="168" fill="rgba(255,255,255,0.5)" fontSize="11" textAnchor="middle">{minPts.toFixed(0)}</text>
                                                                        <text x="210" y="168" fill="rgba(255,255,255,0.5)" fontSize="11" textAnchor="middle">{((minPts + maxPts) / 2).toFixed(0)}</text>
                                                                        <text x="380" y="168" fill="rgba(255,255,255,0.5)" fontSize="11" textAnchor="middle">{maxPts.toFixed(0)}</text>
                                                                        
                                                                        {/* Mean label */}
                                                                        <text 
                                                                            x={40 + 340 * (xPointsAway - minPts) / range} 
                                                                            y="18" 
                                                                            fill="rgb(59, 130, 246)" 
                                                                            fontSize="12" 
                                                                            fontWeight="bold"
                                                                            textAnchor="middle"
                                                                        >
                                                                            Î¼={xPointsAway.toFixed(1)}
                                                                        </text>
                                                                    </>
                                                                );
                                                            })()}
                                                        </svg>
                                                    </div>
                                                    
                                                    {/* Probability ranges */}
                                                    <div className="mt-2 grid grid-cols-3 gap-2 text-center text-xs">
                                                        {(() => {
                                                            const awayPointsData = longData.filter(d => d.team === simAwayTeam).map(d => d.points);
                                                            const stdDev = awayPointsData.length >= 2 
                                                                ? Math.sqrt(awayPointsData.reduce((sum, x) => sum + Math.pow(x - xPointsAway, 2), 0) / awayPointsData.length)
                                                                : 6;
                                                            return (
                                                                <>
                                                                    <div className="bg-white/5 rounded-lg p-2">
                                                                        <p className="text-slate-400">68% prob</p>
                                                                        <p className="font-bold text-blue-400">{(xPointsAway - stdDev).toFixed(0)}-{(xPointsAway + stdDev).toFixed(0)}</p>
                                                                    </div>
                                                                    <div className="bg-white/5 rounded-lg p-2">
                                                                        <p className="text-slate-400">95% prob</p>
                                                                        <p className="font-bold text-blue-400">{(xPointsAway - 2*stdDev).toFixed(0)}-{(xPointsAway + 2*stdDev).toFixed(0)}</p>
                                                                    </div>
                                                                    <div className="bg-white/5 rounded-lg p-2">
                                                                        <p className="text-slate-400">P({'>'}75 pts)</p>
                                                                        <p className="font-bold text-blue-400">{((1 - normalCDF(75, xPointsAway, stdDev)) * 100).toFixed(0)}%</p>
                                                                    </div>
                                                                </>
                                                            );
                                                        })()}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* 1X2 Odds */}
                                            <div className="glass rounded-2xl p-6">
                                                <h3 className="font-bold mb-4">ðŸ“Š Quote 1X2</h3>
                                                <div className="grid grid-cols-3 gap-4">
                                                    <div className="bg-gradient-to-br from-emerald-500/20 to-emerald-600/10 rounded-xl p-5 text-center">
                                                        <p className="text-slate-400 text-sm mb-2">1 ({simHomeTeam.substring(0,8)})</p>
                                                        <p className="text-4xl font-bold text-emerald-400">{(homeWinProb * 100).toFixed(1)}%</p>
                                                        <p className="text-xl font-medium text-slate-300 mt-2">@ {probToOdds(homeWinProb)}</p>
                                                        <div className="mt-3 h-2 bg-white/10 rounded-full overflow-hidden">
                                                            <div className="h-full bg-emerald-500 rounded-full" style={{ width: `${homeWinProb * 100}%` }} />
                                                        </div>
                                                    </div>
                                                    <div className="bg-gradient-to-br from-amber-500/20 to-amber-600/10 rounded-xl p-5 text-center">
                                                        <p className="text-slate-400 text-sm mb-2">X (Pareggio)</p>
                                                        <p className="text-4xl font-bold text-amber-400">{(drawProb * 100).toFixed(1)}%</p>
                                                        <p className="text-xl font-medium text-slate-300 mt-2">@ {probToOdds(drawProb)}</p>
                                                        <div className="mt-3 h-2 bg-white/10 rounded-full overflow-hidden">
                                                            <div className="h-full bg-amber-500 rounded-full" style={{ width: `${drawProb * 100}%` }} />
                                                        </div>
                                                    </div>
                                                    <div className="bg-gradient-to-br from-blue-500/20 to-blue-600/10 rounded-xl p-5 text-center">
                                                        <p className="text-slate-400 text-sm mb-2">2 ({simAwayTeam.substring(0,8)})</p>
                                                        <p className="text-4xl font-bold text-blue-400">{(awayWinProb * 100).toFixed(1)}%</p>
                                                        <p className="text-xl font-medium text-slate-300 mt-2">@ {probToOdds(awayWinProb)}</p>
                                                        <div className="mt-3 h-2 bg-white/10 rounded-full overflow-hidden">
                                                            <div className="h-full bg-blue-500 rounded-full" style={{ width: `${awayWinProb * 100}%` }} />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Over/Under Points */}
                                            <div className="glass rounded-2xl p-6">
                                                <h3 className="font-bold mb-4">ðŸ“ˆ Over/Under Punti Totali</h3>
                                                <p className="text-slate-400 text-sm mb-4">Punti totali attesi: <span className="text-white font-bold">{totalXPoints.toFixed(1)}</span></p>
                                                <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                                                    {overUnderLines.map(line => {
                                                        const overProb = 1 - normalCDF(line, totalXPoints, stdDev);
                                                        const underProb = normalCDF(line, totalXPoints, stdDev);
                                                        return (
                                                            <div key={line} className="bg-white/5 rounded-xl p-4">
                                                                <p className="text-center text-sm text-slate-400 mb-2">Linea {line}</p>
                                                                <div className="flex justify-between text-xs mb-1">
                                                                    <span className="text-emerald-400">Over</span>
                                                                    <span className="text-red-400">Under</span>
                                                                </div>
                                                                <div className="flex h-3 rounded-full overflow-hidden">
                                                                    <div className="bg-emerald-500" style={{ width: `${overProb * 100}%` }} />
                                                                    <div className="bg-red-500" style={{ width: `${underProb * 100}%` }} />
                                                                </div>
                                                                <div className="flex justify-between text-xs mt-1">
                                                                    <span className="text-emerald-400">{(overProb * 100).toFixed(0)}%</span>
                                                                    <span className="text-red-400">{(underProb * 100).toFixed(0)}%</span>
                                                                </div>
                                                                <div className="flex justify-between text-xs mt-1 text-slate-500">
                                                                    <span>@{probToOdds(overProb)}</span>
                                                                    <span>@{probToOdds(underProb)}</span>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                            
                                            {/* Most Likely Scorelines */}
                                            <div className="glass rounded-2xl p-6">
                                                <h3 className="font-bold mb-4">ðŸŽ¯ Risultati PiÃ¹ Probabili (Gol)</h3>
                                                <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                                                    {likelyScores.slice(0, 10).map((score, idx) => (
                                                        <div key={idx} className={`rounded-xl p-4 text-center ${score.home > score.away ? 'bg-emerald-500/10 border border-emerald-500/30' : score.home < score.away ? 'bg-blue-500/10 border border-blue-500/30' : 'bg-amber-500/10 border border-amber-500/30'}`}>
                                                            <p className="text-2xl font-bold">{score.home} - {score.away}</p>
                                                            <p className="text-sm text-slate-400">{(score.prob * 100).toFixed(1)}%</p>
                                                            <p className="text-xs text-slate-500">@{probToOdds(score.prob)}</p>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            
                                            {/* Score Probability Matrix */}
                                            <div className="glass rounded-2xl p-6">
                                                <h3 className="font-bold mb-4">ðŸ“‹ Matrice ProbabilitÃ  Risultati</h3>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead>
                                                            <tr>
                                                                <th className="px-2 py-2 text-slate-400">{simHomeTeam.substring(0,3)} \ {simAwayTeam.substring(0,3)}</th>
                                                                {[0,1,2,3,4,5].map(ag => <th key={ag} className="px-2 py-2 text-blue-400">{ag}</th>)}
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {[0,1,2,3,4,5].map(hg => (
                                                                <tr key={hg}>
                                                                    <td className="px-2 py-2 font-bold text-emerald-400">{hg}</td>
                                                                    {[0,1,2,3,4,5].map(ag => {
                                                                        const prob = scoreMatrix[hg][ag] * 100;
                                                                        const intensity = Math.min(prob * 10, 100);
                                                                        return (
                                                                            <td key={ag} className="px-2 py-2 text-center" style={{ backgroundColor: `rgba(${hg > ag ? '16,185,129' : hg < ag ? '59,130,246' : '245,158,11'},${intensity/100 * 0.5})` }}>
                                                                                {prob.toFixed(1)}%
                                                                            </td>
                                                                        );
                                                                    })}
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <p className="text-xs text-slate-500 mt-3">ðŸŸ¢ Verde = Vittoria Casa | ðŸŸ¡ Giallo = Pareggio | ðŸ”µ Blu = Vittoria Trasferta</p>
                                            </div>
                                        </>
                                    );
                                })()}
                                
                                {(!simHomeTeam || !simAwayTeam) && (
                                    <div className="glass rounded-2xl p-12 text-center">
                                        <div className="text-6xl mb-4">âš½</div>
                                        <p className="text-slate-400">Seleziona entrambe le squadre per vedere la simulazione</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'coachstats' && (() => {
                            // Coach data from the image
                            const coachData = [
                                { name: 'LEO', wins: 29, draws: 5, losses: 21 },
                                { name: 'GIANMARCO', wins: 24, draws: 9, losses: 23 },
                                { name: 'AMATTE', wins: 26, draws: 9, losses: 20 },
                                { name: 'CATELLO', wins: 15, draws: 18, losses: 19 },
                                { name: 'LOLLO', wins: 18, draws: 9, losses: 29 },
                                { name: 'MATTEO NEGRO', wins: 24, draws: 10, losses: 19 },
                                { name: 'ELIA', wins: 5, draws: 3, losses: 5 },
                                { name: 'MARCO', wins: 3, draws: 3, losses: 7 },
                            ].map(coach => ({
                                ...coach,
                                total: coach.wins + coach.draws + coach.losses,
                                winRate: ((coach.wins / (coach.wins + coach.draws + coach.losses)) * 100).toFixed(1),
                                drawRate: ((coach.draws / (coach.wins + coach.draws + coach.losses)) * 100).toFixed(1),
                                lossRate: ((coach.losses / (coach.wins + coach.draws + coach.losses)) * 100).toFixed(1),
                                points: coach.wins * 3 + coach.draws,
                                ppg: ((coach.wins * 3 + coach.draws) / (coach.wins + coach.draws + coach.losses)).toFixed(2)
                            })).sort((a, b) => parseFloat(b.winRate) - parseFloat(a.winRate));
                            
                            // Pearson Chi-Square Test function
                            const runChiSquareTest = () => {
                                if (!coachCompare1 || !coachCompare2 || coachCompare1 === coachCompare2) {
                                    alert('Seleziona due coach diversi');
                                    return;
                                }
                                
                                const c1 = coachData.find(c => c.name === coachCompare1);
                                const c2 = coachData.find(c => c.name === coachCompare2);
                                
                                // Observed values (2x3 contingency table)
                                const observed = [
                                    [c1.wins, c1.draws, c1.losses],
                                    [c2.wins, c2.draws, c2.losses]
                                ];
                                
                                // Calculate row totals, column totals, and grand total
                                const rowTotals = observed.map(row => row.reduce((a, b) => a + b, 0));
                                const colTotals = [0, 1, 2].map(j => observed.reduce((sum, row) => sum + row[j], 0));
                                const grandTotal = rowTotals.reduce((a, b) => a + b, 0);
                                
                                // Calculate expected values
                                const expected = observed.map((row, i) => 
                                    row.map((_, j) => (rowTotals[i] * colTotals[j]) / grandTotal)
                                );
                                
                                // Calculate Chi-Square statistic
                                let chiSquare = 0;
                                for (let i = 0; i < 2; i++) {
                                    for (let j = 0; j < 3; j++) {
                                        chiSquare += Math.pow(observed[i][j] - expected[i][j], 2) / expected[i][j];
                                    }
                                }
                                
                                // Degrees of freedom = (rows - 1) * (cols - 1) = 1 * 2 = 2
                                const df = 2;
                                
                                // Calculate p-value using chi-square distribution
                                // Using gamma function approximation for chi-square CDF
                                const gammainc = (a, x) => {
                                    // Lower incomplete gamma function approximation
                                    if (x < 0) return 0;
                                    if (x === 0) return 0;
                                    
                                    let sum = 0;
                                    let term = 1 / a;
                                    sum = term;
                                    
                                    for (let n = 1; n < 200; n++) {
                                        term *= x / (a + n);
                                        sum += term;
                                        if (Math.abs(term) < 1e-10) break;
                                    }
                                    
                                    return Math.pow(x, a) * Math.exp(-x) * sum;
                                };
                                
                                const gamma = (z) => {
                                    // Lanczos approximation for gamma function
                                    const g = 7;
                                    const c = [
                                        0.99999999999980993,
                                        676.5203681218851,
                                        -1259.1392167224028,
                                        771.32342877765313,
                                        -176.61502916214059,
                                        12.507343278686905,
                                        -0.13857109526572012,
                                        9.9843695780195716e-6,
                                        1.5056327351493116e-7
                                    ];
                                    
                                    if (z < 0.5) {
                                        return Math.PI / (Math.sin(Math.PI * z) * gamma(1 - z));
                                    }
                                    
                                    z -= 1;
                                    let x = c[0];
                                    for (let i = 1; i < g + 2; i++) {
                                        x += c[i] / (z + i);
                                    }
                                    
                                    const t = z + g + 0.5;
                                    return Math.sqrt(2 * Math.PI) * Math.pow(t, z + 0.5) * Math.exp(-t) * x;
                                };
                                
                                // Chi-square CDF using regularized incomplete gamma function
                                const chiSquareCDF = (x, k) => {
                                    if (x <= 0) return 0;
                                    const a = k / 2;
                                    const gam = gamma(a);
                                    return gammainc(a, x / 2) / gam;
                                };
                                
                                const pValue = 1 - chiSquareCDF(chiSquare, df);
                                
                                // CramÃ©r's V (effect size)
                                const n = grandTotal;
                                const minDim = Math.min(2 - 1, 3 - 1); // min(rows-1, cols-1)
                                const cramersV = Math.sqrt(chiSquare / (n * minDim));
                                
                                setChiResult({
                                    coach1: c1,
                                    coach2: c2,
                                    observed,
                                    expected,
                                    chiSquare: chiSquare.toFixed(4),
                                    df,
                                    pValue: pValue.toFixed(6),
                                    cramersV: cramersV.toFixed(4),
                                    significant: pValue < 0.05,
                                    interpretation: pValue < 0.001 ? 'Altamente significativo (p < 0.001)' :
                                                   pValue < 0.01 ? 'Molto significativo (p < 0.01)' :
                                                   pValue < 0.05 ? 'Significativo (p < 0.05)' :
                                                   pValue < 0.1 ? 'Marginalmente significativo (p < 0.1)' :
                                                   'Non significativo (p â‰¥ 0.1)',
                                    effectSize: cramersV < 0.1 ? 'Trascurabile' :
                                               cramersV < 0.3 ? 'Piccolo' :
                                               cramersV < 0.5 ? 'Medio' : 'Grande'
                                });
                            };
                            
                            return (
                                <div className="space-y-6">
                                    <div>
                                        <h2 className="text-xl font-bold">ðŸ† Coach Stats</h2>
                                        <p className="text-slate-400 text-sm mt-1">Statistiche storiche degli allenatori e confronto statistico</p>
                                    </div>
                                    
                                    {/* Legend */}
                                    <div className="glass rounded-xl p-4">
                                        <h3 className="text-sm font-semibold text-slate-300 mb-3">ðŸ“– Legenda</h3>
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs text-slate-400">
                                            <div><span className="text-emerald-400 font-medium">V</span> = Vittorie</div>
                                            <div><span className="text-amber-400 font-medium">P</span> = Pareggi</div>
                                            <div><span className="text-red-400 font-medium">S</span> = Sconfitte</div>
                                            <div><span className="text-white font-medium">Win%</span> = Percentuale vittorie</div>
                                            <div><span className="text-white font-medium">Pts</span> = Punti totali (3V + 1P)</div>
                                            <div><span className="text-white font-medium">PPG</span> = Punti per partita</div>
                                        </div>
                                    </div>
                                    
                                    {/* Top Cards */}
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div className="glass rounded-2xl p-5">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="w-10 h-10 bg-amber-500/20 rounded-xl flex items-center justify-center text-amber-400">ðŸ¥‡</div>
                                                <div>
                                                    <p className="text-slate-400 text-sm">Miglior Win Rate</p>
                                                    <p className="font-bold">Best Coach</p>
                                                </div>
                                            </div>
                                            <div className="text-2xl font-bold text-amber-400">{coachData[0].name}</div>
                                            <div className="text-slate-400 text-sm">{coachData[0].winRate}% vittorie</div>
                                        </div>
                                        <div className="glass rounded-2xl p-5">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="w-10 h-10 bg-emerald-500/20 rounded-xl flex items-center justify-center text-emerald-400">ðŸ†</div>
                                                <div>
                                                    <p className="text-slate-400 text-sm">PiÃ¹ Vittorie</p>
                                                    <p className="font-bold">Most Wins</p>
                                                </div>
                                            </div>
                                            <div className="text-2xl font-bold text-emerald-400">{[...coachData].sort((a,b) => b.wins - a.wins)[0].name}</div>
                                            <div className="text-slate-400 text-sm">{[...coachData].sort((a,b) => b.wins - a.wins)[0].wins} vittorie</div>
                                        </div>
                                        <div className="glass rounded-2xl p-5">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center text-blue-400">ðŸ“Š</div>
                                                <div>
                                                    <p className="text-slate-400 text-sm">PiÃ¹ Partite</p>
                                                    <p className="font-bold">Most Games</p>
                                                </div>
                                            </div>
                                            <div className="text-2xl font-bold text-blue-400">{[...coachData].sort((a,b) => b.total - a.total)[0].name}</div>
                                            <div className="text-slate-400 text-sm">{[...coachData].sort((a,b) => b.total - a.total)[0].total} partite</div>
                                        </div>
                                        <div className="glass rounded-2xl p-5">
                                            <div className="flex items-center gap-3 mb-4">
                                                <div className="w-10 h-10 bg-purple-500/20 rounded-xl flex items-center justify-center text-purple-400">âš¡</div>
                                                <div>
                                                    <p className="text-slate-400 text-sm">Miglior PPG</p>
                                                    <p className="font-bold">Points/Game</p>
                                                </div>
                                            </div>
                                            <div className="text-2xl font-bold text-purple-400">{[...coachData].sort((a,b) => parseFloat(b.ppg) - parseFloat(a.ppg))[0].name}</div>
                                            <div className="text-slate-400 text-sm">{[...coachData].sort((a,b) => parseFloat(b.ppg) - parseFloat(a.ppg))[0].ppg} PPG</div>
                                        </div>
                                    </div>
                                    
                                    {/* Coach Stats Table */}
                                    <div className="glass rounded-2xl overflow-hidden">
                                        <div className="px-6 py-4 bg-white/5 border-b border-white/10">
                                            <h3 className="font-bold">ðŸ“‹ Statistiche Complete Coach</h3>
                                            <p className="text-sm text-slate-400">Ordinato per Win Rate</p>
                                        </div>
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead>
                                                    <tr className="text-sm text-slate-400 border-b border-white/10">
                                                        <th className="px-6 py-3 text-left">#</th>
                                                        <th className="px-6 py-3 text-left">Coach</th>
                                                        <th className="px-4 py-3 text-center">V</th>
                                                        <th className="px-4 py-3 text-center">P</th>
                                                        <th className="px-4 py-3 text-center">S</th>
                                                        <th className="px-4 py-3 text-center">Tot</th>
                                                        <th className="px-4 py-3 text-center">Win%</th>
                                                        <th className="px-4 py-3 text-center">Draw%</th>
                                                        <th className="px-4 py-3 text-center">Loss%</th>
                                                        <th className="px-4 py-3 text-center">Pts</th>
                                                        <th className="px-4 py-3 text-center">PPG</th>
                                                        <th className="px-6 py-3 text-center">Distribuzione</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {coachData.map((coach, idx) => (
                                                        <tr key={coach.name} className="border-b border-white/5 hover:bg-white/5">
                                                            <td className="px-6 py-4">
                                                                <span className={`inline-flex items-center justify-center w-8 h-8 rounded-lg font-bold text-sm ${
                                                                    idx === 0 ? 'bg-gradient-to-br from-amber-400 to-amber-600 text-slate-900' :
                                                                    idx === 1 ? 'bg-gradient-to-br from-slate-300 to-slate-400 text-slate-900' :
                                                                    idx === 2 ? 'bg-gradient-to-br from-orange-400 to-orange-600 text-white' :
                                                                    'bg-white/10 text-white'
                                                                }`}>{idx + 1}</span>
                                                            </td>
                                                            <td className="px-6 py-4 font-bold">{coach.name}</td>
                                                            <td className="px-4 py-4 text-center text-emerald-400 font-medium">{coach.wins}</td>
                                                            <td className="px-4 py-4 text-center text-amber-400 font-medium">{coach.draws}</td>
                                                            <td className="px-4 py-4 text-center text-red-400 font-medium">{coach.losses}</td>
                                                            <td className="px-4 py-4 text-center text-slate-300">{coach.total}</td>
                                                            <td className="px-4 py-4 text-center">
                                                                <span className={`font-bold ${parseFloat(coach.winRate) >= 50 ? 'text-emerald-400' : parseFloat(coach.winRate) >= 40 ? 'text-amber-400' : 'text-red-400'}`}>
                                                                    {coach.winRate}%
                                                                </span>
                                                            </td>
                                                            <td className="px-4 py-4 text-center text-amber-400">{coach.drawRate}%</td>
                                                            <td className="px-4 py-4 text-center text-red-400">{coach.lossRate}%</td>
                                                            <td className="px-4 py-4 text-center font-bold">{coach.points}</td>
                                                            <td className="px-4 py-4 text-center font-bold text-purple-400">{coach.ppg}</td>
                                                            <td className="px-6 py-4">
                                                                <div className="flex h-4 rounded-full overflow-hidden w-32">
                                                                    <div className="bg-emerald-500" style={{ width: `${coach.winRate}%` }} title={`Wins: ${coach.winRate}%`} />
                                                                    <div className="bg-amber-500" style={{ width: `${coach.drawRate}%` }} title={`Draws: ${coach.drawRate}%`} />
                                                                    <div className="bg-red-500" style={{ width: `${coach.lossRate}%` }} title={`Losses: ${coach.lossRate}%`} />
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    {/* Chi-Square Test Tool */}
                                    <div className="glass rounded-2xl p-6">
                                        <h3 className="font-bold mb-2 flex items-center gap-2">ðŸ”¬ Confronto Statistico Coach (Test Chi-Quadrato di Pearson)</h3>
                                        
                                        {/* Detailed explanation */}
                                        <div className="bg-blue-500/10 border border-blue-500/20 rounded-xl p-4 mb-6">
                                            <h4 className="font-semibold text-blue-400 mb-3">ðŸ“š Cos'Ã¨ il Test Chi-Quadrato?</h4>
                                            <div className="text-sm text-slate-300 space-y-3">
                                                <p>
                                                    Il <strong>Test Chi-Quadrato (Ï‡Â²) di Pearson</strong> Ã¨ un test statistico che permette di verificare se esiste una 
                                                    <strong> differenza significativa</strong> tra le distribuzioni di due gruppi. In questo caso, confrontiamo la distribuzione 
                                                    dei risultati (Vittorie, Pareggi, Sconfitte) tra due coach.
                                                </p>
                                                <p>
                                                    <strong>ðŸŽ¯ Domanda a cui risponde:</strong> "I due coach hanno performance statisticamente diverse, 
                                                    o le differenze osservate potrebbero essere dovute al caso?"
                                                </p>
                                                <div className="bg-white/5 rounded-lg p-3 mt-3">
                                                    <p className="font-medium text-white mb-2">Come funziona:</p>
                                                    <ol className="list-decimal list-inside space-y-1 text-slate-400">
                                                        <li>Costruisce una <strong>tabella di contingenza</strong> 2Ã—3 (2 coach Ã— 3 risultati)</li>
                                                        <li>Calcola i <strong>valori attesi</strong> se i coach fossero identici (ipotesi nulla Hâ‚€)</li>
                                                        <li>Confronta i valori <strong>osservati</strong> con quelli <strong>attesi</strong></li>
                                                        <li>Calcola la statistica Ï‡Â² e il relativo <strong>p-value</strong></li>
                                                        <li>Se p-value {"<"} 0.05, la differenza Ã¨ <strong>statisticamente significativa</strong></li>
                                                    </ol>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="bg-amber-500/10 border border-amber-500/20 rounded-xl p-4 mb-6">
                                            <h4 className="font-semibold text-amber-400 mb-2">âš ï¸ Ipotesi del Test</h4>
                                            <div className="text-sm text-slate-300 space-y-2">
                                                <p><strong>Hâ‚€ (Ipotesi Nulla):</strong> I due coach hanno la stessa distribuzione di risultati. 
                                                Le differenze osservate sono dovute al caso.</p>
                                                <p><strong>Hâ‚ (Ipotesi Alternativa):</strong> I due coach hanno distribuzioni di risultati 
                                                significativamente diverse. C'Ã¨ una reale differenza di performance.</p>
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-end mb-6">
                                            <div>
                                                <label className="block text-sm text-slate-400 mb-2">Coach 1</label>
                                                <select 
                                                    value={coachCompare1} 
                                                    onChange={(e) => setCoachCompare1(e.target.value)}
                                                    className="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-emerald-500"
                                                >
                                                    <option value="" className="bg-slate-800">-- Seleziona --</option>
                                                    {coachData.map(c => (
                                                        <option key={c.name} value={c.name} className="bg-slate-800">{c.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="text-center text-2xl font-bold text-slate-500">VS</div>
                                            <div>
                                                <label className="block text-sm text-slate-400 mb-2">Coach 2</label>
                                                <select 
                                                    value={coachCompare2} 
                                                    onChange={(e) => setCoachCompare2(e.target.value)}
                                                    className="w-full bg-white/10 border border-white/20 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500"
                                                >
                                                    <option value="" className="bg-slate-800">-- Seleziona --</option>
                                                    {coachData.filter(c => c.name !== coachCompare1).map(c => (
                                                        <option key={c.name} value={c.name} className="bg-slate-800">{c.name}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <button 
                                            onClick={runChiSquareTest}
                                            className="w-full py-3 bg-gradient-to-r from-emerald-500 to-blue-500 hover:from-emerald-600 hover:to-blue-600 rounded-xl font-bold transition-all"
                                        >
                                            ðŸ§ª Esegui Test Chi-Quadrato
                                        </button>
                                    </div>
                                    
                                    {/* Chi-Square Results */}
                                    {chiResult && (
                                        <div className="glass rounded-2xl p-6 space-y-6">
                                            <h3 className="font-bold text-lg">ðŸ“Š Risultati Test Chi-Quadrato di Pearson</h3>
                                            
                                            {/* Contingency Table */}
                                            <div className="bg-white/5 rounded-xl p-4">
                                                <h4 className="font-semibold mb-2 text-slate-300">ðŸ“‹ Tabella di Contingenza (Valori Osservati)</h4>
                                                <p className="text-xs text-slate-500 mb-3">
                                                    Questa tabella mostra i risultati reali di ogni coach. Sono i dati "osservati" che confronteremo con quelli "attesi".
                                                </p>
                                                <table className="w-full text-sm">
                                                    <thead>
                                                        <tr className="text-slate-400">
                                                            <th className="px-4 py-2 text-left">Coach</th>
                                                            <th className="px-4 py-2 text-center text-emerald-400">Vittorie</th>
                                                            <th className="px-4 py-2 text-center text-amber-400">Pareggi</th>
                                                            <th className="px-4 py-2 text-center text-red-400">Sconfitte</th>
                                                            <th className="px-4 py-2 text-center">Totale</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr className="border-t border-white/10">
                                                            <td className="px-4 py-2 font-bold">{chiResult.coach1.name}</td>
                                                            <td className="px-4 py-2 text-center text-emerald-400">{chiResult.observed[0][0]}</td>
                                                            <td className="px-4 py-2 text-center text-amber-400">{chiResult.observed[0][1]}</td>
                                                            <td className="px-4 py-2 text-center text-red-400">{chiResult.observed[0][2]}</td>
                                                            <td className="px-4 py-2 text-center font-medium">{chiResult.coach1.total}</td>
                                                        </tr>
                                                        <tr className="border-t border-white/10">
                                                            <td className="px-4 py-2 font-bold">{chiResult.coach2.name}</td>
                                                            <td className="px-4 py-2 text-center text-emerald-400">{chiResult.observed[1][0]}</td>
                                                            <td className="px-4 py-2 text-center text-amber-400">{chiResult.observed[1][1]}</td>
                                                            <td className="px-4 py-2 text-center text-red-400">{chiResult.observed[1][2]}</td>
                                                            <td className="px-4 py-2 text-center font-medium">{chiResult.coach2.total}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            {/* Expected Values */}
                                            <div className="bg-white/5 rounded-xl p-4">
                                                <h4 className="font-semibold mb-2 text-slate-300">ðŸŽ¯ Valori Attesi (sotto Hâ‚€)</h4>
                                                <p className="text-xs text-slate-500 mb-3">
                                                    Questi sono i valori che ci aspetteremmo se i due coach fossero identici nelle performance. 
                                                    Vengono calcolati come: E = (Totale Riga Ã— Totale Colonna) / Totale Generale
                                                </p>
                                                <table className="w-full text-sm">
                                                    <thead>
                                                        <tr className="text-slate-400">
                                                            <th className="px-4 py-2 text-left">Coach</th>
                                                            <th className="px-4 py-2 text-center">E(Vittorie)</th>
                                                            <th className="px-4 py-2 text-center">E(Pareggi)</th>
                                                            <th className="px-4 py-2 text-center">E(Sconfitte)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr className="border-t border-white/10">
                                                            <td className="px-4 py-2 font-bold">{chiResult.coach1.name}</td>
                                                            <td className="px-4 py-2 text-center text-slate-300">{chiResult.expected[0][0].toFixed(2)}</td>
                                                            <td className="px-4 py-2 text-center text-slate-300">{chiResult.expected[0][1].toFixed(2)}</td>
                                                            <td className="px-4 py-2 text-center text-slate-300">{chiResult.expected[0][2].toFixed(2)}</td>
                                                        </tr>
                                                        <tr className="border-t border-white/10">
                                                            <td className="px-4 py-2 font-bold">{chiResult.coach2.name}</td>
                                                            <td className="px-4 py-2 text-center text-slate-300">{chiResult.expected[1][0].toFixed(2)}</td>
                                                            <td className="px-4 py-2 text-center text-slate-300">{chiResult.expected[1][1].toFixed(2)}</td>
                                                            <td className="px-4 py-2 text-center text-slate-300">{chiResult.expected[1][2].toFixed(2)}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            {/* Test Statistics with Explanations */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div className="bg-white/5 rounded-xl p-4">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <p className="text-slate-400 text-sm">Chi-Square (Ï‡Â²)</p>
                                                        <p className="text-2xl font-bold text-white">{chiResult.chiSquare}</p>
                                                    </div>
                                                    <p className="text-xs text-slate-500">
                                                        Misura quanto i valori osservati si discostano da quelli attesi. 
                                                        PiÃ¹ Ã¨ alto, maggiore Ã¨ la differenza tra i due coach.
                                                    </p>
                                                </div>
                                                <div className="bg-white/5 rounded-xl p-4">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <p className="text-slate-400 text-sm">Gradi di LibertÃ  (df)</p>
                                                        <p className="text-2xl font-bold text-white">{chiResult.df}</p>
                                                    </div>
                                                    <p className="text-xs text-slate-500">
                                                        Parametro del test: df = (righe-1) Ã— (colonne-1) = (2-1) Ã— (3-1) = 2. 
                                                        Serve per calcolare il p-value dalla distribuzione Ï‡Â².
                                                    </p>
                                                </div>
                                                <div className={`rounded-xl p-4 ${chiResult.significant ? 'bg-emerald-500/10 border border-emerald-500/30' : 'bg-red-500/10 border border-red-500/30'}`}>
                                                    <div className="flex items-center justify-between mb-2">
                                                        <p className="text-slate-400 text-sm">p-value</p>
                                                        <p className={`text-2xl font-bold ${chiResult.significant ? 'text-emerald-400' : 'text-red-400'}`}>
                                                            {parseFloat(chiResult.pValue) < 0.001 ? '< 0.001' : chiResult.pValue}
                                                        </p>
                                                    </div>
                                                    <p className="text-xs text-slate-500">
                                                        <strong>ProbabilitÃ </strong> di osservare questa differenza (o maggiore) se Hâ‚€ fosse vera. 
                                                        {chiResult.significant 
                                                            ? " Ãˆ BASSO â†’ la differenza Ã¨ significativa!" 
                                                            : " Ãˆ ALTO â†’ la differenza potrebbe essere casuale."}
                                                    </p>
                                                </div>
                                                <div className="bg-purple-500/10 border border-purple-500/30 rounded-xl p-4">
                                                    <div className="flex items-center justify-between mb-2">
                                                        <p className="text-slate-400 text-sm">CramÃ©r's V</p>
                                                        <p className="text-2xl font-bold text-purple-400">{chiResult.cramersV}</p>
                                                    </div>
                                                    <p className="text-xs text-slate-500">
                                                        <strong>Effect Size</strong> - Misura la forza dell'associazione (0-1). 
                                                        Indica QUANTO sono diversi i coach, non solo SE lo sono.
                                                    </p>
                                                </div>
                                            </div>
                                            
                                            {/* Detailed Interpretation */}
                                            <div className={`rounded-xl p-5 ${chiResult.significant ? 'bg-emerald-500/10 border border-emerald-500/30' : 'bg-red-500/10 border border-red-500/30'}`}>
                                                <h4 className={`font-bold mb-3 text-lg ${chiResult.significant ? 'text-emerald-400' : 'text-red-400'}`}>
                                                    {chiResult.significant ? 'âœ… Differenza Statisticamente Significativa' : 'âŒ Nessuna Differenza Statisticamente Significativa'}
                                                </h4>
                                                
                                                <div className="space-y-3 text-sm">
                                                    <div className="bg-white/5 rounded-lg p-3">
                                                        <p className="font-medium text-white mb-1">ðŸ“Š Livello di SignificativitÃ :</p>
                                                        <p className="text-slate-300">{chiResult.interpretation}</p>
                                                        <div className="mt-2 text-xs text-slate-500">
                                                            <span className="inline-block mr-3">p {"<"} 0.001 = Altamente significativo â­â­â­</span>
                                                            <span className="inline-block mr-3">p {"<"} 0.01 = Molto significativo â­â­</span>
                                                            <span className="inline-block mr-3">p {"<"} 0.05 = Significativo â­</span>
                                                            <span className="inline-block">p â‰¥ 0.05 = Non significativo</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="bg-white/5 rounded-lg p-3">
                                                        <p className="font-medium text-white mb-1">ðŸ“ Dimensione dell'Effetto (CramÃ©r's V = {chiResult.cramersV}):</p>
                                                        <p className="text-slate-300">{chiResult.effectSize}</p>
                                                        <div className="mt-2 text-xs text-slate-500">
                                                            <span className="inline-block mr-3">V {"<"} 0.1 = Trascurabile</span>
                                                            <span className="inline-block mr-3">0.1-0.3 = Piccolo</span>
                                                            <span className="inline-block mr-3">0.3-0.5 = Medio</span>
                                                            <span className="inline-block">V {">"} 0.5 = Grande</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="bg-white/5 rounded-lg p-3">
                                                        <p className="font-medium text-white mb-1">ðŸŽ¯ Conclusione in parole semplici:</p>
                                                        <p className="text-slate-300">
                                                            {chiResult.significant 
                                                                ? `Con un p-value di ${chiResult.pValue}, possiamo affermare con ${parseFloat(chiResult.pValue) < 0.01 ? 'alta' : 'buona'} confidenza che ${chiResult.coach1.name} e ${chiResult.coach2.name} hanno performance REALMENTE diverse. La differenza nei loro risultati NON Ã¨ dovuta al caso.`
                                                                : `Con un p-value di ${chiResult.pValue}, NON possiamo affermare che ${chiResult.coach1.name} e ${chiResult.coach2.name} siano diversi. Le differenze osservate nei loro risultati potrebbero essere semplicemente dovute al caso o alla variabilitÃ  normale.`
                                                            }
                                                        </p>
                                                    </div>
                                                    
                                                    {chiResult.significant && (
                                                        <div className="bg-white/5 rounded-lg p-3">
                                                            <p className="font-medium text-white mb-1">ðŸ” Dove sta la differenza?</p>
                                                            <p className="text-slate-300">
                                                                {parseFloat(chiResult.coach1.winRate) > parseFloat(chiResult.coach2.winRate)
                                                                    ? `${chiResult.coach1.name} ha un Win Rate superiore (${chiResult.coach1.winRate}% vs ${chiResult.coach2.winRate}%).`
                                                                    : `${chiResult.coach2.name} ha un Win Rate superiore (${chiResult.coach2.winRate}% vs ${chiResult.coach1.winRate}%).`
                                                                }
                                                                {' '}
                                                                {Math.abs(parseFloat(chiResult.coach1.drawRate) - parseFloat(chiResult.coach2.drawRate)) > 5
                                                                    ? `C'Ã¨ anche una differenza notevole nei pareggi (${chiResult.coach1.drawRate}% vs ${chiResult.coach2.drawRate}%).`
                                                                    : ''
                                                                }
                                                            </p>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* Visual Comparison */}
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div className="bg-white/5 rounded-xl p-4">
                                                    <h4 className="font-semibold mb-3 text-emerald-400">{chiResult.coach1.name}</h4>
                                                    <div className="space-y-2">
                                                        <div className="flex items-center gap-2">
                                                            <span className="w-16 text-sm text-slate-400">Vittorie</span>
                                                            <div className="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                                                                <div className="h-full bg-emerald-500 rounded-full flex items-center justify-end pr-2" style={{ width: `${chiResult.coach1.winRate}%` }}>
                                                                    <span className="text-xs font-bold">{chiResult.coach1.winRate}%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="w-16 text-sm text-slate-400">Pareggi</span>
                                                            <div className="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                                                                <div className="h-full bg-amber-500 rounded-full flex items-center justify-end pr-2" style={{ width: `${chiResult.coach1.drawRate}%` }}>
                                                                    <span className="text-xs font-bold">{chiResult.coach1.drawRate}%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="w-16 text-sm text-slate-400">Sconfitte</span>
                                                            <div className="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                                                                <div className="h-full bg-red-500 rounded-full flex items-center justify-end pr-2" style={{ width: `${chiResult.coach1.lossRate}%` }}>
                                                                    <span className="text-xs font-bold">{chiResult.coach1.lossRate}%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="mt-3 pt-3 border-t border-white/10 text-xs text-slate-500">
                                                        Totale partite: {chiResult.coach1.total} | PPG: {chiResult.coach1.ppg}
                                                    </div>
                                                </div>
                                                <div className="bg-white/5 rounded-xl p-4">
                                                    <h4 className="font-semibold mb-3 text-blue-400">{chiResult.coach2.name}</h4>
                                                    <div className="space-y-2">
                                                        <div className="flex items-center gap-2">
                                                            <span className="w-16 text-sm text-slate-400">Vittorie</span>
                                                            <div className="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                                                                <div className="h-full bg-emerald-500 rounded-full flex items-center justify-end pr-2" style={{ width: `${chiResult.coach2.winRate}%` }}>
                                                                    <span className="text-xs font-bold">{chiResult.coach2.winRate}%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="w-16 text-sm text-slate-400">Pareggi</span>
                                                            <div className="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                                                                <div className="h-full bg-amber-500 rounded-full flex items-center justify-end pr-2" style={{ width: `${chiResult.coach2.drawRate}%` }}>
                                                                    <span className="text-xs font-bold">{chiResult.coach2.drawRate}%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <span className="w-16 text-sm text-slate-400">Sconfitte</span>
                                                            <div className="flex-1 h-6 bg-white/10 rounded-full overflow-hidden">
                                                                <div className="h-full bg-red-500 rounded-full flex items-center justify-end pr-2" style={{ width: `${chiResult.coach2.lossRate}%` }}>
                                                                    <span className="text-xs font-bold">{chiResult.coach2.lossRate}%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="mt-3 pt-3 border-t border-white/10 text-xs text-slate-500">
                                                        Totale partite: {chiResult.coach2.total} | PPG: {chiResult.coach2.ppg}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Formula Box */}
                                            <div className="bg-slate-800/50 rounded-xl p-4 text-sm">
                                                <h4 className="font-semibold mb-3 text-slate-300">ðŸ“ Formule Matematiche Utilizzate</h4>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <div>
                                                        <p className="text-slate-400 mb-1">Statistica Chi-Quadrato:</p>
                                                        <p className="text-white font-mono bg-white/5 p-2 rounded">Ï‡Â² = Î£ [(O - E)Â² / E]</p>
                                                        <p className="text-xs text-slate-500 mt-1">O = osservato, E = atteso</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-slate-400 mb-1">Valore Atteso:</p>
                                                        <p className="text-white font-mono bg-white/5 p-2 rounded">E = (Tot.Riga Ã— Tot.Col) / N</p>
                                                        <p className="text-xs text-slate-500 mt-1">N = totale generale</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-slate-400 mb-1">Gradi di LibertÃ :</p>
                                                        <p className="text-white font-mono bg-white/5 p-2 rounded">df = (r-1) Ã— (c-1) = 2</p>
                                                        <p className="text-xs text-slate-500 mt-1">r = righe, c = colonne</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-slate-400 mb-1">CramÃ©r's V:</p>
                                                        <p className="text-white font-mono bg-white/5 p-2 rounded">V = âˆš(Ï‡Â² / (N Ã— min(r-1,c-1)))</p>
                                                        <p className="text-xs text-slate-500 mt-1">Effect size normalizzato 0-1</p>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Note */}
                                            <div className="bg-slate-700/30 rounded-xl p-4 text-xs text-slate-500">
                                                <p className="font-medium text-slate-400 mb-1">ðŸ“ Note Metodologiche:</p>
                                                <ul className="list-disc list-inside space-y-1">
                                                    <li>Il test assume che le osservazioni siano indipendenti</li>
                                                    <li>Ãˆ consigliato avere almeno 5 osservazioni attese per cella</li>
                                                    <li>Î± = 0.05 Ã¨ il livello di significativitÃ  standard (5% di probabilitÃ  di errore Tipo I)</li>
                                                    <li>Un risultato "non significativo" non significa che i coach siano identici, ma che non c'Ã¨ evidenza sufficiente per affermare il contrario</li>
                                                </ul>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })()}

                        {activeTab === 'toolculo' && (
                            <div className="space-y-4">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h2 className="text-xl font-bold">ðŸŽ² Tool Culo - Analizzatore Fortuna</h2>
                                        <p className="text-slate-400 text-sm">Analisi fortuna completa per il fantacalcio</p>
                                    </div>
                                    <button 
                                        onClick={() => {
                                            const iframe = document.getElementById('toolculo-iframe');
                                            if (iframe.requestFullscreen) iframe.requestFullscreen();
                                        }}
                                        className="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition-colors"
                                    >
                                        â›¶ Fullscreen
                                    </button>
                                </div>
                                
                                <div className="glass rounded-2xl overflow-hidden" style={{ height: 'calc(100vh - 200px)', minHeight: '600px' }}>
                                    <iframe 
                                        id="toolculo-iframe"
                                        srcDoc={`<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ðŸŽ² Fantacalcio Luck Analyzer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f172a; padding: 20px; color: #e2e8f0; }
    .container { max-width: 1200px; margin: 0 auto; background: rgba(30, 41, 59, 0.8); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
    h1 { text-align: center; color: #f1f5f9; margin-bottom: 5px; font-size: 24px; }
    .subtitle { text-align: center; color: #94a3b8; margin-bottom: 20px; font-size: 14px; }
    .tabs { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 15px; }
    .tab { padding: 8px 16px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 13px; color: #e2e8f0; transition: all 0.2s; }
    .tab:hover { background: rgba(255,255,255,0.15); }
    .tab.active { background: rgba(16, 185, 129, 0.3); border: 1px solid rgba(16, 185, 129, 0.5); border-bottom: none; font-weight: bold; color: #10b981; }
    .content { border: 1px solid rgba(255,255,255,0.1); border-radius: 0 8px 8px 8px; padding: 20px; min-height: 400px; background: rgba(15, 23, 42, 0.5); }
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s; }
    .btn-primary { background: #10b981; color: white; }
    .btn-secondary { background: #3b82f6; color: white; }
    .btn-purple { background: #8b5cf6; color: white; }
    .btn-orange { background: #f97316; color: white; }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 13px; }
    th, td { border: 1px solid rgba(255,255,255,0.1); padding: 8px; text-align: center; }
    th { background: rgba(255,255,255,0.05); font-weight: bold; color: #94a3b8; }
    td { color: #e2e8f0; }
    input[type="text"], input[type="number"] { width: 100%; padding: 6px; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; font-size: 13px; background: rgba(255,255,255,0.1); color: #e2e8f0; }
    input:focus { outline: none; border-color: #10b981; }
    .info-box { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 15px; border-radius: 6px; margin: 15px 0; font-size: 13px; color: #94a3b8; }
    .info-box b { display: block; margin-bottom: 5px; color: #e2e8f0; }
    .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 15px 0; }
    .card { border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; background: rgba(255,255,255,0.05); }
    .card h3 { font-size: 14px; margin-bottom: 10px; color: #e2e8f0; }
    .luck-positive { background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
    .luck-negative { background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
    .luck-neutral { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; color: #94a3b8; }
    label { font-size: 13px; font-weight: 500; color: #e2e8f0; }
    .hidden { display: none; }
    .whatif-controls { background: linear-gradient(135deg, rgba(102,126,234,0.3) 0%, rgba(118,75,162,0.3) 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
    .whatif-controls label { color: white; }
    .whatif-controls input[type="number"] { width: 120px; padding: 8px; border: none; border-radius: 6px; font-size: 14px; background: rgba(255,255,255,0.2); color: white; }
    .progress-container { background: rgba(255,255,255,0.1); border-radius: 10px; height: 20px; overflow: hidden; margin: 15px 0; }
    .progress-bar { background: linear-gradient(90deg, #10b981, #3b82f6); height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold; }
    .simulation-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
    .stat-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; text-align: center; }
    .stat-card .value { font-size: 28px; font-weight: bold; color: #10b981; }
    .stat-card .label { font-size: 12px; color: #94a3b8; margin-top: 5px; }
    .position-bar { height: 24px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; display: flex; }
    .position-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; min-width: 20px; }
    .highlight-row { background: rgba(251, 191, 36, 0.2) !important; }
    .highlight-row td { font-weight: bold; color: #fbbf24; }
    .comparison-arrow { font-size: 16px; margin: 0 5px; }
    .comparison-arrow.up { color: #10b981; }
    .comparison-arrow.down { color: #ef4444; }
    .comparison-arrow.same { color: #94a3b8; }
    .whatif-legend { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin: 15px 0; font-size: 12px; }
    .whatif-legend-item { display: flex; align-items: center; gap: 5px; color: #94a3b8; }
    .whatif-legend-color { width: 16px; height: 16px; border-radius: 3px; }
    .h2h-matrix { overflow-x: auto; }
    .h2h-matrix table { font-size: 11px; }
    .h2h-matrix th, .h2h-matrix td { padding: 6px; min-width: 70px; }
    .h2h-matrix .team-header { writing-mode: vertical-rl; text-orientation: mixed; transform: rotate(180deg); max-width: 40px; height: 100px; font-weight: bold; }
    .h2h-cell { position: relative; }
    .h2h-cell .record { font-weight: bold; font-size: 12px; }
    .h2h-cell .details { font-size: 9px; color: #94a3b8; margin-top: 2px; }
    .h2h-win { background: rgba(16, 185, 129, 0.2); }
    .h2h-lose { background: rgba(239, 68, 68, 0.2); }
    .h2h-draw { background: rgba(251, 191, 36, 0.2); }
    .h2h-self { background: rgba(255,255,255,0.05); }
    .h2h-no-match { background: rgba(255,255,255,0.02); color: #64748b; }
    .kryptonite-card { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; padding: 15px; }
    .kryptonite-card h4 { color: #ef4444; margin-bottom: 10px; }
    .victim-card { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 15px; }
    .victim-card h4 { color: #10b981; margin-bottom: 10px; }
    .rival-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 6px; }
    .rival-item .name { font-weight: bold; color: #e2e8f0; }
    .rival-item .record { font-size: 12px; color: #94a3b8; }
    .dominance-bar { height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; display: flex; }
    .dominance-segment { height: 100%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: white; }
    .dominance-wins { background: #10b981; }
    .dominance-draws { background: #f59e0b; }
    .dominance-losses { background: #ef4444; }
    .variance-meter { position: relative; height: 40px; background: linear-gradient(90deg, rgba(239,68,68,0.3) 0%, rgba(251,191,36,0.3) 25%, rgba(16,185,129,0.3) 50%, rgba(251,191,36,0.3) 75%, rgba(239,68,68,0.3) 100%); border-radius: 8px; margin: 10px 0; }
    .variance-range { position: absolute; height: 100%; background: rgba(59, 130, 246, 0.3); border: 2px solid #3b82f6; border-radius: 6px; }
    .variance-median { position: absolute; width: 4px; height: 100%; background: #1d4ed8; border-radius: 2px; transform: translateX(-50%); }
    .variance-floor { position: absolute; width: 3px; height: 100%; background: #ef4444; transform: translateX(-50%); }
    .variance-ceiling { position: absolute; width: 3px; height: 100%; background: #10b981; transform: translateX(-50%); }
    .variance-dot { position: absolute; width: 8px; height: 8px; background: #94a3b8; border-radius: 50%; top: 50%; transform: translate(-50%, -50%); }
    .variance-label { position: absolute; font-size: 9px; font-weight: bold; top: -14px; transform: translateX(-50%); white-space: nowrap; color: #e2e8f0; }
    .reliable-badge { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .boom-bust-badge { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
    .consistency-bar { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
    .consistency-fill { height: 100%; border-radius: 4px; }
    .sparkline { display: flex; align-items: flex-end; gap: 2px; height: 30px; }
    .sparkline-bar { flex: 1; background: #3b82f6; border-radius: 2px 2px 0 0; min-width: 4px; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ² Fantacalcio Luck Analyzer</h1>
    <p class="subtitle">Analisi fortuna completa per il tuo fantacalcio</p>
    
    <div class="tabs">
      <button class="tab active" onclick="showTab('input')">ðŸ“ Dati</button>
      <button class="tab" onclick="showTab('results')">ðŸ“Š Fortuna</button>
      <button class="tab" onclick="showTab('stats')">ðŸ“ˆ Stats</button>
      <button class="tab" onclick="showTab('pythagorean')">ðŸ”¬ Pitagorica</button>
      <button class="tab" onclick="showTab('schedule')">ðŸ“… Calendario</button>
      <button class="tab" onclick="showTab('rankings')">ðŸ† Top</button>
      <button class="tab" onclick="showTab('whatif')">ðŸŽ° What If</button>
      <button class="tab" onclick="showTab('h2h')">âš”ï¸ Scontri</button>
      <button class="tab" onclick="showTab('variance')">ðŸ“‰ Varianza</button>
    </div>
    
    <div class="content">
      <div id="tab-input">
        <div class="info-box" style="margin-bottom: 15px;">
          <b>ðŸ“– Benvenuto nel Fantacalcio Luck Analyzer!</b>
          <br><br>
          <b>ðŸŽ¯ A cosa serve questo strumento?</b>
          <br>Questo tool analizza i risultati del tuo fantacalcio per scoprire quanto la FORTUNA (o sfortuna) abbia influenzato la tua stagione.
          <br><br>
          <b>ðŸ“ Come inserire i dati:</b>
          <br>1. <b>Numero di giornate</b>: Imposta quante giornate sono state giocate
          <br>2. <b>Per ogni squadra inserisci</b>: Nome, Punteggi di ogni giornata, Vittorie (V), Pareggi (P)
          <br>3. Clicca <b>"ðŸŽ¯ Calcola"</b> per generare tutte le analisi
          <br><br>
          <b>âš ï¸ Importante:</b> I punteggi sono i punti fantacalcio (es: 72.5), NON i punti classifica!
        </div>
        
        <div class="flex">
          <label>Giornate: <input type="number" id="days" value="10" min="1" max="38" style="width:60px" onchange="updateDays()"></label>
          <button class="btn btn-secondary" onclick="addTeam()">+ Squadra</button>
          <label class="btn btn-purple" style="cursor:pointer">ðŸ“ Importa CSV<input type="file" accept=".csv" onchange="loadFile(event)" style="display:none"></label>
        </div>
        
        <div class="info-box">
          <b>ðŸ“‹ Importazione CSV:</b>
          <br><b>Formato:</b> <code>Nome,G1,G2,G3,...,Vinte,Pareggi</code>
          <br>Oppure: <code>Giornata,HomeTeam,AwayTeam,HomePts,AwayPts,Result</code>
        </div>
        
        <div id="table-container"></div>
        
        <button class="btn btn-primary" style="width:100%; margin-top:15px" onclick="calculate()">ðŸŽ¯ Calcola</button>
      </div>
      
      <div id="tab-results" class="hidden"></div>
      <div id="tab-stats" class="hidden"></div>
      <div id="tab-pythagorean" class="hidden"></div>
      <div id="tab-schedule" class="hidden"></div>
      <div id="tab-rankings" class="hidden"></div>
      <div id="tab-whatif" class="hidden"></div>
      <div id="tab-h2h" class="hidden"></div>
      <div id="tab-variance" class="hidden"></div>
    </div>
  </div>

  <script>
    let teams = [
      { name: 'Squadra 1', scores: Array(10).fill(''), wins: '', draws: '' },
      { name: 'Squadra 2', scores: Array(10).fill(''), wins: '', draws: '' }
    ];
    let days = 10;
    let results = null;
    let whatIfResults = null;
    let h2hData = null;
    let varianceData = null;

    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.add('hidden'));
      event.target.classList.add('active');
      document.getElementById('tab-' + tab).classList.remove('hidden');
    }

    function updateDays() {
      days = Math.max(1, Math.min(38, parseInt(document.getElementById('days').value) || 10));
      teams = teams.map(t => ({ ...t, scores: Array(days).fill('').map((_, i) => t.scores[i] || '') }));
      renderTable();
    }

    function addTeam() {
      teams.push({ name: 'Squadra ' + (teams.length + 1), scores: Array(days).fill(''), wins: '', draws: '' });
      renderTable();
    }

    function removeTeam(idx) {
      if (teams.length > 2) { teams.splice(idx, 1); renderTable(); }
    }

    function renderTable() {
      document.getElementById('table-container').innerHTML = 
        '<table><thead><tr><th style="text-align:left">Nome</th>' +
        Array(days).fill(0).map((_, i) => '<th>G'+(i+1)+'</th>').join('') +
        '<th style="background:rgba(16,185,129,0.2)">V</th><th style="background:rgba(251,191,36,0.2)">P</th><th></th>' +
        '</tr></thead><tbody>' +
        teams.map((t, i) => 
          '<tr><td><input value="'+t.name+'" onchange="teams['+i+'].name=this.value"></td>' +
          Array(days).fill(0).map((_, j) => '<td><input type="number" value="'+t.scores[j]+'" onchange="teams['+i+'].scores['+j+']=this.value"></td>').join('') +
          '<td style="background:rgba(16,185,129,0.2)"><input type="number" value="'+t.wins+'" onchange="teams['+i+'].wins=this.value"></td>' +
          '<td style="background:rgba(251,191,36,0.2)"><input type="number" value="'+t.draws+'" onchange="teams['+i+'].draws=this.value"></td>' +
          '<td><button onclick="removeTeam('+i+')" style="border:none;background:none;color:#ef4444;font-size:20px;cursor:pointer">Ã—</button></td></tr>'
        ).join('') +
        '</tbody></table>';
    }

    function loadFile(e) {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const lines = ev.target.result.split(/\\r?\\n/).filter(l => l.trim());
          const fl = lines[0].toLowerCase();
          
          if (fl.includes('hometeam') || fl.includes('awayteam')) {
            const sep = fl.includes(';') ? ';' : ',';
            const matches = lines.slice(1).map(l => {
              const c = l.split(sep).map(x => x.trim());
              return { day: +c[0], home: c[1], away: c[2], hp: +c[3], ap: +c[4], res: c[5] };
            }).filter(m => m.day && m.home && m.away);
            
            const allTeams = [...new Set(matches.flatMap(m => [m.home, m.away]))];
            days = Math.max(...matches.map(m => m.day));
            document.getElementById('days').value = days;
            
            teams = allTeams.map(name => {
              const scores = Array(days).fill('');
              let wins = 0, draws = 0;
              matches.filter(m => m.home === name || m.away === name).forEach(m => {
                const isHome = m.home === name;
                const pts = isHome ? m.hp : m.ap;
                scores[m.day - 1] = pts;
                if ((isHome && m.res === 'H') || (!isHome && m.res === 'A')) wins++;
                else if (m.res === 'D') draws++;
              });
              return { name, scores, wins: wins.toString(), draws: draws.toString() };
            });
          } else {
            const sep = fl.includes(';') ? ';' : ',';
            const data = lines.map(l => l.split(sep).map(x => x.trim()));
            const headers = data[0].map(h => h.toLowerCase());
            const nameIdx = headers.findIndex(h => h.includes('nome') || h.includes('team') || h.includes('squadra'));
            const winsIdx = headers.findIndex(h => h.includes('vint') || h.includes('win') || h === 'v' || h === 'w');
            const drawsIdx = headers.findIndex(h => h.includes('pareg') || h.includes('draw') || h === 'p' || h === 'd');
            
            const scoreIdxs = headers.map((h, i) => (h.match(/^g\\d+$/) || h.match(/^\\d+$/) || h.includes('giornata')) ? i : -1).filter(i => i !== -1);
            if (scoreIdxs.length === 0) {
              for (let i = 0; i < headers.length; i++) {
                if (i !== nameIdx && i !== winsIdx && i !== drawsIdx && !isNaN(parseFloat(data[1]?.[i]))) scoreIdxs.push(i);
              }
            }
            
            days = scoreIdxs.length;
            document.getElementById('days').value = days;
            
            teams = data.slice(1).filter(r => r[nameIdx]).map(r => ({
              name: r[nameIdx] || '',
              scores: scoreIdxs.map(i => r[i] || ''),
              wins: winsIdx >= 0 ? (r[winsIdx] || '') : '',
              draws: drawsIdx >= 0 ? (r[drawsIdx] || '') : ''
            }));
          }
          
          renderTable();
          alert('âœ… Dati importati: ' + teams.length + ' squadre, ' + days + ' giornate');
        } catch (err) {
          alert('âŒ Errore: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    function calculate() {
      const valid = teams.filter(t => t.name && t.scores.some(s => s !== ''));
      if (valid.length < 2) { alert('Inserisci almeno 2 squadre con punteggi'); return; }
      
      results = valid.map(t => {
        const scores = t.scores.map(s => parseFloat(s) || 0).filter(s => s > 0);
        const avg = scores.length ? scores.reduce((a, b) => a + b, 0) / scores.length : 0;
        const wins = parseInt(t.wins) || 0;
        const draws = parseInt(t.draws) || 0;
        const losses = Math.max(0, scores.length - wins - draws);
        return { name: t.name, scores, avg, wins, draws, losses, total: scores.reduce((a, b) => a + b, 0) };
      });
      
      const allScores = results.flatMap(r => r.scores).sort((a, b) => a - b);
      const n = results.length;
      
      results.forEach(r => {
        let virtualWins = 0, virtualDraws = 0;
        r.scores.forEach(myScore => {
          const dayScores = results.filter(x => x !== r).flatMap(x => x.scores.length > r.scores.indexOf(myScore) ? [x.scores[r.scores.indexOf(myScore)]] : []);
          dayScores.forEach(oppScore => {
            if (myScore > oppScore) virtualWins++;
            else if (myScore === oppScore) virtualDraws++;
          });
        });
        
        const gamesVirtual = r.scores.length * (n - 1);
        r.virtualWins = virtualWins;
        r.virtualDraws = virtualDraws;
        r.virtualLosses = gamesVirtual - virtualWins - virtualDraws;
        r.virtualWinRate = gamesVirtual > 0 ? (virtualWins / gamesVirtual * 100) : 0;
        
        const expectedWins = r.scores.length * r.virtualWinRate / 100;
        const expectedDraws = r.scores.length * (virtualDraws / gamesVirtual);
        r.expectedWins = expectedWins;
        r.expectedDraws = expectedDraws;
        
        r.luckWins = r.wins - expectedWins;
        r.luckDraws = r.draws - expectedDraws;
        r.luckIndex = (r.luckWins * 3 + r.luckDraws * 1);
        
        const stdDev = Math.sqrt(r.scores.reduce((sum, s) => sum + Math.pow(s - r.avg, 2), 0) / r.scores.length);
        r.stdDev = stdDev;
        r.consistency = 100 - Math.min(stdDev * 2, 100);
        r.high = Math.max(...r.scores);
        r.low = Math.min(...r.scores);
      });
      
      results.sort((a, b) => b.luckIndex - a.luckIndex);
      
      renderResults();
      renderStats();
      renderPythagorean();
      renderSchedule();
      renderRankings();
      renderWhatIf();
      calculateH2H();
      calculateVariance();
    }

    function renderResults() {
      const html = '<h3>ðŸ“Š Analisi Fortuna</h3>' +
        '<div class="info-box"><b>Come leggere i risultati:</b><br>' +
        'â€¢ <b>Indice Fortuna</b>: Positivo = fortunato, Negativo = sfortunato<br>' +
        'â€¢ <b>Vittorie Attese</b>: Quante vittorie "meritavi" in base ai punteggi<br>' +
        'â€¢ <b>Win Rate Virtuale</b>: % vittorie se giocassi contro tutti ogni giornata</div>' +
        '<table><thead><tr><th>Squadra</th><th>Media</th><th>V Reali</th><th>V Attese</th><th>Diff</th><th>Win Rate</th><th>Fortuna</th></tr></thead><tbody>' +
        results.map(r => 
          '<tr><td style="text-align:left;font-weight:bold">' + r.name + '</td>' +
          '<td>' + r.avg.toFixed(1) + '</td>' +
          '<td>' + r.wins + '</td>' +
          '<td>' + r.expectedWins.toFixed(1) + '</td>' +
          '<td class="' + (r.luckWins >= 0 ? 'luck-positive' : 'luck-negative') + '">' + (r.luckWins >= 0 ? '+' : '') + r.luckWins.toFixed(1) + '</td>' +
          '<td>' + r.virtualWinRate.toFixed(1) + '%</td>' +
          '<td><span class="' + (r.luckIndex >= 2 ? 'luck-positive' : r.luckIndex <= -2 ? 'luck-negative' : 'luck-neutral') + '">' + (r.luckIndex >= 0 ? '+' : '') + r.luckIndex.toFixed(1) + '</span></td></tr>'
        ).join('') +
        '</tbody></table>';
      document.getElementById('tab-results').innerHTML = html;
    }

    function renderStats() {
      const sorted = [...results].sort((a, b) => b.avg - a.avg);
      document.getElementById('tab-stats').innerHTML = '<h3>ðŸ“ˆ Statistiche Complete</h3>' +
        '<table><thead><tr><th>Squadra</th><th>Media</th><th>Totale</th><th>Max</th><th>Min</th><th>Std Dev</th><th>Consistenza</th></tr></thead><tbody>' +
        sorted.map(r => 
          '<tr><td style="text-align:left;font-weight:bold">' + r.name + '</td>' +
          '<td>' + r.avg.toFixed(2) + '</td>' +
          '<td>' + r.total.toFixed(1) + '</td>' +
          '<td style="color:#10b981">' + r.high.toFixed(1) + '</td>' +
          '<td style="color:#ef4444">' + r.low.toFixed(1) + '</td>' +
          '<td>' + r.stdDev.toFixed(2) + '</td>' +
          '<td><div class="consistency-bar"><div class="consistency-fill" style="width:' + r.consistency + '%;background:' + (r.consistency > 70 ? '#10b981' : r.consistency > 40 ? '#f59e0b' : '#ef4444') + '"></div></div></td></tr>'
        ).join('') +
        '</tbody></table>';
    }

    function renderPythagorean() {
      const pyth = results.map(r => {
        const exp = Math.pow(r.avg, 2) / (Math.pow(r.avg, 2) + Math.pow(70, 2));
        const expectedPts = r.scores.length * 3 * exp;
        const realPts = r.wins * 3 + r.draws;
        return { ...r, pythWinRate: exp * 100, expectedPts, realPts, pythDiff: realPts - expectedPts };
      }).sort((a, b) => b.pythWinRate - a.pythWinRate);
      
      document.getElementById('tab-pythagorean').innerHTML = '<h3>ðŸ”¬ Classifica Pitagorica</h3>' +
        '<div class="info-box"><b>Formula Pitagorica:</b> Win% = PFÂ² / (PFÂ² + PAÂ²)<br>Stima la % di vittorie attesa basandosi sui punti fatti.</div>' +
        '<table><thead><tr><th>#</th><th>Squadra</th><th>Media</th><th>Win% Atteso</th><th>Pts Reali</th><th>Pts Attesi</th><th>Diff</th></tr></thead><tbody>' +
        pyth.map((r, i) => 
          '<tr><td>' + (i + 1) + '</td><td style="text-align:left;font-weight:bold">' + r.name + '</td>' +
          '<td>' + r.avg.toFixed(1) + '</td>' +
          '<td>' + r.pythWinRate.toFixed(1) + '%</td>' +
          '<td>' + r.realPts + '</td>' +
          '<td>' + r.expectedPts.toFixed(1) + '</td>' +
          '<td class="' + (r.pythDiff >= 0 ? 'luck-positive' : 'luck-negative') + '">' + (r.pythDiff >= 0 ? '+' : '') + r.pythDiff.toFixed(1) + '</td></tr>'
        ).join('') +
        '</tbody></table>';
    }

    function renderSchedule() {
      document.getElementById('tab-schedule').innerHTML = '<h3>ðŸ“… DifficoltÃ  Calendario</h3>' +
        '<div class="info-box">Analisi della forza degli avversari affrontati (basata sulla media punti).</div>' +
        '<p style="color:#94a3b8;text-align:center;padding:40px">FunzionalitÃ  disponibile con dati calendario completi</p>';
    }

    function renderRankings() {
      const luckiest = [...results].sort((a, b) => b.luckIndex - a.luckIndex)[0];
      const unluckiest = [...results].sort((a, b) => a.luckIndex - b.luckIndex)[0];
      const mostConsistent = [...results].sort((a, b) => a.stdDev - b.stdDev)[0];
      const bestAvg = [...results].sort((a, b) => b.avg - a.avg)[0];
      const highestScore = [...results].sort((a, b) => b.high - a.high)[0];
      
      document.getElementById('tab-rankings').innerHTML = '<h3>ðŸ† Premi & Classifiche</h3>' +
        '<div class="grid">' +
        '<div class="card"><h3>ðŸ€ PiÃ¹ Fortunato</h3><div style="font-size:24px;font-weight:bold;color:#10b981">' + luckiest.name + '</div><div style="color:#94a3b8">Indice: +' + luckiest.luckIndex.toFixed(1) + '</div></div>' +
        '<div class="card"><h3>ðŸ˜¢ PiÃ¹ Sfortunato</h3><div style="font-size:24px;font-weight:bold;color:#ef4444">' + unluckiest.name + '</div><div style="color:#94a3b8">Indice: ' + unluckiest.luckIndex.toFixed(1) + '</div></div>' +
        '<div class="card"><h3>ðŸŽ¯ PiÃ¹ Costante</h3><div style="font-size:24px;font-weight:bold;color:#3b82f6">' + mostConsistent.name + '</div><div style="color:#94a3b8">Std Dev: ' + mostConsistent.stdDev.toFixed(2) + '</div></div>' +
        '<div class="card"><h3>ðŸ“Š Miglior Media</h3><div style="font-size:24px;font-weight:bold;color:#8b5cf6">' + bestAvg.name + '</div><div style="color:#94a3b8">Media: ' + bestAvg.avg.toFixed(2) + '</div></div>' +
        '<div class="card"><h3>ðŸš€ Record Punteggio</h3><div style="font-size:24px;font-weight:bold;color:#f59e0b">' + highestScore.name + '</div><div style="color:#94a3b8">Max: ' + highestScore.high.toFixed(1) + '</div></div>' +
        '</div>';
    }

    function renderWhatIf() {
      document.getElementById('tab-whatif').innerHTML = '<h3>ðŸŽ° What If - Simulazione Calendari</h3>' +
        '<div class="whatif-controls"><label>Numero simulazioni: <input type="number" id="simCount" value="1000" min="100" max="10000"></label> ' +
        '<button class="btn btn-primary" onclick="runWhatIf()">â–¶ï¸ Simula</button></div>' +
        '<div id="whatif-results"><p style="color:#94a3b8;text-align:center;padding:40px">Clicca "Simula" per generare calendari casuali</p></div>';
    }

    function runWhatIf() {
      const simCount = parseInt(document.getElementById('simCount').value) || 1000;
      const n = results.length;
      const positionCounts = results.map(() => Array(n).fill(0));
      
      for (let sim = 0; sim < simCount; sim++) {
        const standings = results.map(r => ({ name: r.name, pts: 0, scores: [...r.scores] }));
        
        for (let day = 0; day < days; day++) {
          const dayTeams = standings.filter(t => t.scores[day] > 0);
          const shuffled = [...dayTeams].sort(() => Math.random() - 0.5);
          
          for (let i = 0; i < shuffled.length - 1; i += 2) {
            const t1 = shuffled[i], t2 = shuffled[i + 1];
            if (t1.scores[day] > t2.scores[day]) { t1.pts += 3; }
            else if (t1.scores[day] < t2.scores[day]) { t2.pts += 3; }
            else { t1.pts += 1; t2.pts += 1; }
          }
        }
        
        standings.sort((a, b) => b.pts - a.pts);
        standings.forEach((t, pos) => {
          const idx = results.findIndex(r => r.name === t.name);
          positionCounts[idx][pos]++;
        });
      }
      
      whatIfResults = results.map((r, i) => ({
        name: r.name,
        positions: positionCounts[i],
        avgPos: positionCounts[i].reduce((sum, count, pos) => sum + count * (pos + 1), 0) / simCount,
        first: positionCounts[i][0] / simCount * 100,
        top3: (positionCounts[i][0] + positionCounts[i][1] + positionCounts[i][2]) / simCount * 100,
        last: positionCounts[i][n - 1] / simCount * 100
      })).sort((a, b) => a.avgPos - b.avgPos);
      
      const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#ec4899', '#06b6d4', '#84cc16'];
      
      document.getElementById('whatif-results').innerHTML = 
        '<div class="simulation-stats">' +
        '<div class="stat-card"><div class="value">' + simCount.toLocaleString() + '</div><div class="label">Simulazioni</div></div>' +
        '<div class="stat-card"><div class="value">' + whatIfResults[0].name + '</div><div class="label">Favorito #1</div></div>' +
        '<div class="stat-card"><div class="value">' + whatIfResults[0].first.toFixed(1) + '%</div><div class="label">Prob. Vittoria</div></div>' +
        '</div>' +
        '<table><thead><tr><th>Squadra</th><th>Pos Media</th><th>% 1Â°</th><th>% Top 3</th><th>% Ultimo</th><th>Distribuzione Posizioni</th></tr></thead><tbody>' +
        whatIfResults.map((r, i) => 
          '<tr><td style="text-align:left;font-weight:bold">' + r.name + '</td>' +
          '<td>' + r.avgPos.toFixed(2) + '</td>' +
          '<td style="color:#10b981;font-weight:bold">' + r.first.toFixed(1) + '%</td>' +
          '<td>' + r.top3.toFixed(1) + '%</td>' +
          '<td style="color:#ef4444">' + r.last.toFixed(1) + '%</td>' +
          '<td><div class="position-bar">' + r.positions.map((count, pos) => 
            '<div class="position-segment" style="width:' + (count / simCount * 100) + '%;background:' + colors[pos % colors.length] + '">' + (count / simCount > 0.05 ? Math.round(count / simCount * 100) + '%' : '') + '</div>'
          ).join('') + '</div></td></tr>'
        ).join('') +
        '</tbody></table>' +
        '<div class="whatif-legend">' + results.map((r, i) => '<div class="whatif-legend-item"><div class="whatif-legend-color" style="background:' + colors[i % colors.length] + '"></div>' + (i + 1) + 'Â° posto</div>').join('') + '</div>';
    }

    function calculateH2H() {
      h2hData = {};
      results.forEach(t1 => {
        h2hData[t1.name] = {};
        results.forEach(t2 => {
          if (t1.name === t2.name) return;
          let wins = 0, draws = 0, losses = 0, ptsFor = 0, ptsAgainst = 0;
          t1.scores.forEach((s1, i) => {
            const s2 = t2.scores[i];
            if (s1 > 0 && s2 > 0) {
              ptsFor += s1; ptsAgainst += s2;
              if (s1 > s2) wins++;
              else if (s1 < s2) losses++;
              else draws++;
            }
          });
          h2hData[t1.name][t2.name] = { wins, draws, losses, ptsFor, ptsAgainst, matches: wins + draws + losses };
        });
      });
      renderH2H();
    }

    function renderH2H() {
      let html = '<h3>âš”ï¸ Scontri Virtuali - Testa a Testa</h3>' +
        '<div class="info-box">Matrice degli scontri diretti: ogni cella mostra V-P-S se le due squadre avessero giocato ogni giornata l\\'una contro l\\'altra.</div>' +
        '<div class="h2h-matrix"><table><thead><tr><th></th>';
      
      results.forEach(t => { html += '<th><div class="team-header">' + t.name + '</div></th>'; });
      html += '</tr></thead><tbody>';
      
      results.forEach(t1 => {
        html += '<tr><th style="text-align:left;font-weight:bold">' + t1.name + '</th>';
        results.forEach(t2 => {
          if (t1.name === t2.name) {
            html += '<td class="h2h-self">-</td>';
          } else {
            const h2h = h2hData[t1.name][t2.name];
            const cls = h2h.wins > h2h.losses ? 'h2h-win' : h2h.wins < h2h.losses ? 'h2h-lose' : 'h2h-draw';
            html += '<td class="h2h-cell ' + cls + '"><div class="record">' + h2h.wins + '-' + h2h.draws + '-' + h2h.losses + '</div></td>';
          }
        });
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      document.getElementById('tab-h2h').innerHTML = html;
    }

    function calculateVariance() {
      varianceData = results.map(r => {
        const sorted = [...r.scores].sort((a, b) => a - b);
        const q1 = sorted[Math.floor(sorted.length * 0.25)];
        const q3 = sorted[Math.floor(sorted.length * 0.75)];
        const iqr = q3 - q1;
        const cv = r.stdDev / r.avg * 100;
        return { ...r, q1, q3, iqr, cv, isReliable: cv < 10 };
      }).sort((a, b) => a.cv - b.cv);
      renderVariance();
    }

    function renderVariance() {
      const allScores = results.flatMap(r => r.scores);
      const minScore = Math.min(...allScores);
      const maxScore = Math.max(...allScores);
      const range = maxScore - minScore;
      
      let html = '<h3>ðŸ“‰ Analisi Varianza</h3>' +
        '<div class="info-box"><b>CV (Coefficiente di Variazione)</b>: Misura la dispersione relativa. CV < 10% = squadra affidabile.</div>' +
        '<table><thead><tr><th>Squadra</th><th>Media</th><th>Std Dev</th><th>CV%</th><th>Min-Max</th><th>Tipo</th><th>Distribuzione</th></tr></thead><tbody>';
      
      varianceData.forEach(r => {
        const barLeft = (r.low - minScore) / range * 100;
        const barWidth = (r.high - r.low) / range * 100;
        const avgPos = (r.avg - minScore) / range * 100;
        
        html += '<tr><td style="text-align:left;font-weight:bold">' + r.name + '</td>' +
          '<td>' + r.avg.toFixed(1) + '</td>' +
          '<td>' + r.stdDev.toFixed(2) + '</td>' +
          '<td>' + r.cv.toFixed(1) + '%</td>' +
          '<td>' + r.low.toFixed(0) + '-' + r.high.toFixed(0) + '</td>' +
          '<td>' + (r.isReliable ? '<span class="reliable-badge">Affidabile</span>' : '<span class="boom-bust-badge">Boom/Bust</span>') + '</td>' +
          '<td style="width:200px"><div class="variance-meter" style="height:20px"><div class="variance-range" style="left:' + barLeft + '%;width:' + barWidth + '%"></div><div class="variance-median" style="left:' + avgPos + '%"></div></div></td></tr>';
      });
      
      html += '</tbody></table>';
      document.getElementById('tab-variance').innerHTML = html;
    }

    renderTable();
  <\/script>
</body>
</html>`}
                                        style={{ 
                                            width: '100%', 
                                            height: '100%', 
                                            border: 'none',
                                            borderRadius: '16px'
                                        }}
                                        title="Tool Culo - Luck Analyzer"
                                    />
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="relative border-t border-white/10 mt-12">
                        <div className="max-w-7xl mx-auto px-6 py-6">
                            <p className="text-center text-slate-500 text-sm">FantaSmegma League 2025/26 â€¢ Carica i CSV Gol e Punti settimanalmente per aggiornare</p>
                        </div>
                    </footer>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
